<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="application-name" content="å¥åº·è¿½è¸ªå™¨">
    <title>å¥åº·è¿½è¸ªå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .input-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .input-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .input-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-card h3::before {
            content: '';
            width: 4px;
            height: 25px;
            background: #667eea;
            border-radius: 2px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.2em;
            font-weight: bold;
        }

        .stat-card .unit {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .history-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .history-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .history-table tr:hover {
            background: #f5f7fa;
        }

        .history-table .surplus {
            color: #e74c3c;
            font-weight: 600;
        }

        .history-table .deficit {
            color: #27ae60;
            font-weight: 600;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        /* å¿«é€Ÿé€‰æ‹©åˆ—è¡¨æ ·å¼ */
        .quick-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-select-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-select-item:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        /* è‡ªç„¶è¯­è¨€è¾“å…¥å¯¹è¯æ¡†æ ·å¼ */
        .nl-input-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
        }

        .nl-input-section h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .nl-input-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-family: inherit;
            resize: vertical;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
        }

        .nl-input-section textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .nl-input-section .btn {
            background: white;
            color: #667eea;
        }

        .nl-input-section .btn:hover {
            background: #f0f0f0;
            color: #764ba2;
        }

        .nl-examples {
            margin-top: 15px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .nl-examples p {
            margin-bottom: 8px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* è§¦æ‘¸ä¼˜åŒ– */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        input,
        textarea,
        select,
        button {
            -webkit-appearance: none;
            -webkit-border-radius: 0;
        }

        .btn {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .quick-select-item {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* æ»šåŠ¨ä¼˜åŒ– */
        .container {
            -webkit-overflow-scrolling: touch;
        }

        /* é˜²æ­¢iOS Safariçš„åŒå‡»ç¼©æ”¾ */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="date"],
        textarea {
            font-size: 16px !important;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 25px;
            }

            .input-section,
            .stats-section,
            .charts-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .input-card {
                padding: 20px;
            }

            .input-card h3 {
                font-size: 1.2em;
            }

            .chart-card {
                padding: 20px;
            }

            .chart-card h3 {
                font-size: 1.1em;
            }

            .chart-container {
                height: 250px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-card .value {
                font-size: 1.8em;
            }

            .history-section {
                padding: 20px;
            }

            .history-section h3 {
                font-size: 1.1em;
            }

            .history-table {
                font-size: 0.85em;
            }

            .history-table th,
            .history-table td {
                padding: 10px 8px;
            }

            .btn {
                padding: 12px;
                font-size: 1em;
            }

            .input-group input,
            .input-group select {
                padding: 10px 12px;
                font-size: 0.95em;
            }

            .nl-input-section {
                padding: 20px;
            }

            .nl-input-section h3 {
                font-size: 1.3em;
            }

            .nl-input-section textarea {
                min-height: 100px;
                font-size: 1em;
            }

            .quick-select-item {
                font-size: 0.8em;
                padding: 5px 12px;
            }

            /* å†å²è®°å½•è¡¨æ ¼åœ¨å°å±å¹•ä¸Šæ”¹ä¸ºå¡ç‰‡å¼å¸ƒå±€ */
            .history-table thead {
                display: none;
            }

            .history-table tbody tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                padding: 15px;
                background: #fff;
            }

            .history-table tbody td {
                display: block;
                text-align: left;
                padding: 8px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .history-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #667eea;
                display: inline-block;
                width: 100px;
                margin-right: 10px;
            }

            .history-table tbody td:last-child {
                border-bottom: none;
                padding-top: 15px;
            }

            /* å†å²è®°å½•æŒ‰é’®åŒºåŸŸä¼˜åŒ– */
            .history-section > div:first-child {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .history-section > div:first-child > div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .delete-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }

            .input-card,
            .chart-card,
            .history-section {
                padding: 15px;
            }

            .stat-card .value {
                font-size: 1.5em;
            }

            .chart-container {
                height: 200px;
            }

            .btn {
                padding: 10px;
                font-size: 0.9em;
            }
        }

        /* åº•éƒ¨å®‰å…¨åŒºåŸŸé€‚é…ï¼ˆiOS åˆ˜æµ·å±ï¼‰ */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .container {
                padding-bottom: calc(15px + env(safe-area-inset-bottom));
            }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸƒâ€â™€ï¸ å¥åº·è¿½è¸ªå™¨</h1>

        <!-- è‡ªç„¶è¯­è¨€è¾“å…¥ -->
        <div class="nl-input-section">
            <h3>ğŸ¤– æ™ºèƒ½è®°å½•ï¼ˆè‡ªç„¶è¯­è¨€è¾“å…¥ï¼‰</h3>
            <textarea id="naturalLanguageInput" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æˆ‘åƒäº†ç•ªèŒ„ç‚’è›‹20gå’Œç±³é¥­150gï¼Œè·‘æ­¥äº†30åˆ†é’Ÿï¼Œä½“é‡70kgï¼Œèƒ¸å›´95cmï¼Œè…°å›´80cmï¼Œè‡‚å›´30cmï¼Œè…¿å›´55cm"></textarea>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 18px; padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border-radius: 12px; border: 2px solid #e0e0e0;">
                <label style="font-weight: 600; color: #667eea; font-size: 15px; display: flex; align-items: center; gap: 6px;">
                    ğŸ“… é€‰æ‹©æ—¥æœŸï¼š
                </label>
                <input type="date" id="nlDateInput" onchange="syncDates(this)" style="flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; font-weight: 500; color: #333; background: white; cursor: pointer; transition: all 0.3s ease;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
            </div>
            <button class="btn" onclick="parseNaturalLanguage()">ğŸ¤– æ™ºèƒ½è§£æå¹¶æ·»åŠ </button>
            <div class="nl-examples">
                <p><strong>ğŸ’¡ ç¤ºä¾‹ï¼š</strong></p>
                <p>â€¢ ä»Šå¤©ä½“é‡70kgï¼Œèƒ¸å›´95cmï¼Œè…°å›´80cmï¼Œåƒäº†ç•ªèŒ„ç‚’è›‹20gã€ç±³é¥­150gï¼Œè·‘æ­¥30åˆ†é’Ÿ</p>
                <p>â€¢ åˆé¤ï¼šçº¢çƒ§è‚‰100gã€é’èœ200gï¼Œæ™šé¤ï¼šé¢æ¡150gï¼Œæ¸¸æ³³45åˆ†é’Ÿï¼Œè…°å›´79cmï¼Œè‡‚å›´31cm</p>
                <p>â€¢ æ—©é¤ç‰›å¥¶250mlã€é¸¡è›‹1ä¸ªï¼Œä½“é‡69.5kgï¼Œå¥èº«1å°æ—¶ï¼Œèƒ¸å›´96cmï¼Œè…¿å›´56cm</p>
            </div>
        </div>

        <!-- API Key è®¾ç½® -->
        <div class="input-card" style="margin-bottom: 25px;">
            <h3>ğŸ”‘ AI è®¾ç½®</h3>
            <div class="input-group">
                <label>API Keyï¼ˆæœ¬åœ°å­˜å‚¨ï¼Œä»…ä½ å¯è§ï¼‰</label>
                <input type="password" id="apiKey" value="sk-C8grNelZw3iKAR3C3Vu88CnbqpOMrUCB5d5pFbUpIkZjB37W" style="font-family: monospace;">
            </div>
            <div class="input-group">
                <label>API ç«¯ç‚¹</label>
                <input type="text" id="apiEndpoint" value="https://vg.v1api.cc/v1" style="font-family: monospace;">
            </div>
            <div class="input-group">
                <label>æ¨¡å‹åç§°</label>
                <input type="text" id="modelName" value="gpt-4o-mini">
            </div>
            <button class="btn" onclick="saveApiKey()" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">ä¿å­˜é…ç½®</button>
            <button class="btn" onclick="testApiConnection()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">æµ‹è¯•è¿æ¥</button>
        </div>

        <div class="input-section">
            <div class="input-card">
                <h3>ğŸ“Š ä½“é‡è®°å½•</h3>
                <div class="input-group">
                    <label>ğŸ“… æ—¥æœŸ</label>
                    <input type="date" id="weightDate" value="" onchange="syncDates(this)">
                </div>
                <div class="input-group">
                    <label>èº«é«˜</label>
                    <input type="number" id="heightValue" step="0.1" placeholder="ä¾‹å¦‚ï¼š175" oninput="calculateBMI()">
                </div>
                <div class="input-group">
                    <label>ä½“é‡ (kg)</label>
                    <input type="number" id="weightValue" step="0.1" placeholder="ä¾‹å¦‚ï¼š70.5" oninput="calculateBMI()">
                </div>
                <div class="input-group">
                    <label>å¹´é¾„</label>
                    <input type="number" id="ageValue" step="1" placeholder="ä¾‹å¦‚ï¼š25" oninput="calculateBMI()">
                </div>
                <div class="input-group">
                    <label>æ€§åˆ«</label>
                    <select id="genderValue" onchange="calculateBMI()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                <div id="bmiResult" style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; display: none; margin-bottom: 15px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">å¥åº·è¯„ä¼°</h4>
                    <p><strong>BMIå€¼ï¼š</strong><span id="bmiValue">--</span></p>
                    <p><strong>çŠ¶æ€ï¼š</strong><span id="bmiStatus">--</span></p>
                    <p style="font-size: 0.85em; color: #666; margin-top: 8px;">* åŸºäºæ€§åˆ«å’Œå¹´é¾„çš„ä½“è„‚ç‡è¯„ä¼°æ–¹æ³•</p>
                </div>
                <button class="btn" onclick="addWeight()">æ·»åŠ ä½“é‡</button>
            </div>

            <div class="input-card">
                <h3>ğŸ“ å›´åº¦è®°å½•</h3>
                <div class="input-group">
                    <label>ğŸ“… æ—¥æœŸ</label>
                    <input type="date" id="measureDate" value="" onchange="syncDates(this)">
                </div>
                <div class="input-group">
                    <label>èƒ¸å›´ (cm)</label>
                    <input type="number" id="chestValue" step="0.1" placeholder="ä¾‹å¦‚ï¼š95">
                </div>
                <div class="input-group">
                    <label>è…°å›´ (cm)</label>
                    <input type="number" id="waistValue" step="0.1" placeholder="ä¾‹å¦‚ï¼š80">
                </div>
                <div class="input-group">
                    <label>è‡‚å›´ (cm)</label>
                    <input type="number" id="armValue" step="0.1" placeholder="ä¾‹å¦‚ï¼š30">
                </div>
                <div class="input-group">
                    <label>è…¿å›´ (cm)</label>
                    <input type="number" id="legValue" step="0.1" placeholder="ä¾‹å¦‚ï¼š55">
                </div>
                <button class="btn" onclick="addMeasurement()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">æ·»åŠ å›´åº¦</button>
            </div>

            <div class="input-card">
                <h3>ğŸ¥— é¥®é£Ÿè®°å½•</h3>
                <div class="input-group">
                    <label>ğŸ“… æ—¥æœŸ</label>
                    <input type="date" id="dietDate" value="" onchange="syncDates(this)">
                </div>
                <div class="input-group">
                    <label>è¾“å…¥æ–¹å¼</label>
                    <select id="dietInputMode" onchange="toggleDietInputMode()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                        <option value="smart">ğŸ¤– æ™ºèƒ½è¾“å…¥ï¼ˆæ¨èï¼‰</option>
                        <option value="manual">âš™ï¸ æ‰‹åŠ¨è¾“å…¥</option>
                    </select>
                </div>
                <div id="smartDietInput">
                    <div class="input-group">
                        <label>é£Ÿç‰©æè¿°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰</label>
                        <input type="text" id="foodDescription" placeholder="ä¾‹å¦‚ï¼šç•ªèŒ„ç‚’è›‹20gï¼Œç±³é¥­150g">
                    </div>
                    <div class="input-group">
                        <label>å¿«é€Ÿé€‰æ‹©ï¼š</label>
                        <div class="quick-select">
                            <span class="quick-select-item" onclick="quickSelectFood('ç±³é¥­150g')">ğŸš ç±³é¥­150g</span>
                            <span class="quick-select-item" onclick="quickSelectFood('ç•ªèŒ„ç‚’è›‹20g')">ğŸ… ç•ªèŒ„ç‚’è›‹20g</span>
                            <span class="quick-select-item" onclick="quickSelectFood('é¸¡è›‹1ä¸ª')">ğŸ¥š é¸¡è›‹1ä¸ª</span>
                            <span class="quick-select-item" onclick="quickSelectFood('ç‰›å¥¶250ml')">ğŸ¥› ç‰›å¥¶250ml</span>
                            <span class="quick-select-item" onclick="quickSelectFood('è‹¹æœ1ä¸ª')">ğŸ è‹¹æœ1ä¸ª</span>
                            <span class="quick-select-item" onclick="quickSelectFood('çº¢çƒ§è‚‰100g')">ğŸ¥© çº¢çƒ§è‚‰100g</span>
                            <span class="quick-select-item" onclick="quickSelectFood('é¢æ¡150g')">ğŸ é¢æ¡150g</span>
                            <span class="quick-select-item" onclick="quickSelectFood('é’èœ200g')">ğŸ¥¬ é’èœ200g</span>
                        </div>
                    </div>
                    <button class="btn" onclick="analyzeFood()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">ğŸ¤– AI è§£æé£Ÿç‰©</button>
                    <div id="foodAnalysisResult" style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; display: none;"></div>
                </div>
                <div id="manualDietInput" style="display: none;">
                    <div class="input-group">
                        <label>è›‹ç™½è´¨ (g)</label>
                        <input type="number" id="protein" step="1" placeholder="ä¾‹å¦‚ï¼š80">
                    </div>
                    <div class="input-group">
                        <label>è„‚è‚ª (g)</label>
                        <input type="number" id="fat" step="1" placeholder="ä¾‹å¦‚ï¼š50">
                    </div>
                    <div class="input-group">
                        <label>ç¢³æ°´åŒ–åˆç‰© (g)</label>
                        <input type="number" id="carbs" step="1" placeholder="ä¾‹å¦‚ï¼š200">
                    </div>
                </div>
                <button class="btn" onclick="addDiet()">æ·»åŠ é¥®é£Ÿ</button>
            </div>

            <div class="input-card">
                <h3>ğŸ’ª è¿åŠ¨è®°å½•</h3>
                <div class="input-group">
                    <label>ğŸ“… æ—¥æœŸ</label>
                    <input type="date" id="exerciseDate" value="" onchange="syncDates(this)">
                </div>
                <div class="input-group">
                    <label>è¾“å…¥æ–¹å¼</label>
                    <select id="exerciseInputMode" onchange="toggleExerciseInputMode()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                        <option value="smart">ğŸ¤– æ™ºèƒ½è¾“å…¥ï¼ˆæ¨èï¼‰</option>
                        <option value="manual">âš™ï¸ æ‰‹åŠ¨è¾“å…¥</option>
                    </select>
                </div>
                <div id="smartExerciseInput">
                    <div class="input-group">
                        <label>è¿åŠ¨æè¿°</label>
                        <input type="text" id="exerciseDescription" placeholder="ä¾‹å¦‚ï¼šè·‘æ­¥30åˆ†é’Ÿï¼Œæ¸¸æ³³45åˆ†é’Ÿ">
                    </div>
                    <div class="input-group">
                        <label>å¿«é€Ÿé€‰æ‹©ï¼š</label>
                        <div class="quick-select">
                            <span class="quick-select-item" onclick="quickSelectExercise('è·‘æ­¥30åˆ†é’Ÿ')">ğŸƒ è·‘æ­¥30åˆ†é’Ÿ</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('æ¸¸æ³³45åˆ†é’Ÿ')">ğŸŠ æ¸¸æ³³45åˆ†é’Ÿ</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('å¥èº«1å°æ—¶')">ğŸ‹ï¸ å¥èº«1å°æ—¶</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('æ•£æ­¥1å°æ—¶')">ğŸš¶ æ•£æ­¥1å°æ—¶</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('éª‘è‡ªè¡Œè½¦30åˆ†é’Ÿ')">ğŸš´ éª‘è‡ªè¡Œè½¦30åˆ†é’Ÿ</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('ç‘œä¼½1å°æ—¶')">ğŸ§˜ ç‘œä¼½1å°æ—¶</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('æ‰“ç¯®çƒ1å°æ—¶')">ğŸ€ æ‰“ç¯®çƒ1å°æ—¶</span>
                            <span class="quick-select-item" onclick="quickSelectExercise('è·³ç»³15åˆ†é’Ÿ')">â±ï¸ è·³ç»³15åˆ†é’Ÿ</span>
                        </div>
                    </div>
                    <button class="btn" onclick="calculateExerciseCalories()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">ğŸ¤– AI è®¡ç®—å¡è·¯é‡Œ</button>
                    <div id="exerciseCaloriesResult" style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; display: none;"></div>
                </div>
                <div id="manualExerciseInput" style="display: none;">
                    <div class="input-group">
                        <label>æ¶ˆè€—å¡è·¯é‡Œ (kcal)</label>
                        <input type="number" id="exerciseCalories" step="1" placeholder="ä¾‹å¦‚ï¼š300">
                    </div>
                </div>
                <button class="btn" onclick="addExercise()">æ·»åŠ è¿åŠ¨</button>
            </div>
        </div>

        <div class="stats-section">
            <div class="stat-card">
                <div class="label" id="intakeLabel">ä»Šæ—¥æ‘„å…¥å¡è·¯é‡Œ</div>
                <div class="value" id="todayIntake">0</div>
                <div class="unit">kcal</div>
            </div>
            <div class="stat-card">
                <div class="label" id="burnedLabel">ä»Šæ—¥æ¶ˆè€—å¡è·¯é‡Œ</div>
                <div class="value" id="todayBurned">0</div>
                <div class="unit">kcal</div>
            </div>
            <div class="stat-card">
                <div class="label" id="balanceLabel">ä»Šæ—¥å¡è·¯é‡Œ</div>
                <div class="value" id="todayBalance">0</div>
                <div class="unit">kcal</div>
            </div>
            <div class="stat-card">
                <div class="label" id="weightLabel">å½“å‰ä½“é‡</div>
                <div class="value" id="currentWeight">--</div>
                <div class="unit">kg</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ“Š è¥å…»æ„æˆåˆ†æ</h3>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border-radius: 10px; border: 2px solid #e0e0e0;">
                        <label for="nutritionDate" style="font-size: 0.95em; color: #667eea; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                            ğŸ“… é€‰æ‹©æ—¥æœŸï¼š
                        </label>
                        <input type="date" id="nutritionDate" onchange="syncDates(this); updateNutritionPieChartForDate();" style="flex: 1; padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; font-weight: 500; background: white; cursor: pointer; transition: all 0.3s ease;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="nutritionPieChart"></canvas>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¤– AI è¥å…»åˆ†æ</h4>
                    <div id="nutritionAnalysis" style="min-height: 100px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                        <p style="color: #999; font-style: italic;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–AIè¥å…»åˆ†æ...</p>
                    </div>
                    <button class="btn" onclick="analyzeNutritionStructure()" style="margin-top: 15px; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); font-size: 0.95em; padding: 12px;">ğŸ¤– åˆ†æé¥®é£Ÿç»“æ„</button>
                </div>
            </div>
            <div class="chart-card">
                <h3>ğŸ“ˆ å¡è·¯é‡Œè¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="caloriesLineChart"></canvas>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¤– AI è¿åŠ¨è¶‹åŠ¿åˆ†æ</h4>
                    <div id="exerciseTrendAnalysis" style="min-height: 100px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                        <p style="color: #999; font-style: italic;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–AIè¿åŠ¨è¶‹åŠ¿åˆ†æ...</p>
                    </div>
                    <button class="btn" onclick="analyzeExerciseTrend()" style="margin-top: 15px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); font-size: 0.95em; padding: 12px;">ğŸ¤– åˆ†æè¿åŠ¨è¶‹åŠ¿</button>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h3>âš–ï¸ ä½“é‡è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="weightLineChart"></canvas>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¤– AI ä½“é‡è¶‹åŠ¿åˆ†æ</h4>
                    <div id="weightTrendAnalysis" style="min-height: 100px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                        <p style="color: #999; font-style: italic;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–AIä½“é‡è¶‹åŠ¿åˆ†æ...</p>
                    </div>
                    <button class="btn" onclick="analyzeWeightTrend()" style="margin-top: 15px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); font-size: 0.95em; padding: 12px;">ğŸ¤– åˆ†æä½“é‡è¶‹åŠ¿</button>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #667eea; margin: 0;">ğŸ“Š å½“å‰ BMI æŒ‡æ•°</h4>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 0.9em; color: #666;">é€‰æ‹©æ—¥æœŸï¼š</label>
                            <input type="date" id="bmiDate" onchange="syncDates(this)" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9em; background: white;">
                        </div>
                    </div>
                    <div id="currentBMI" style="min-height: 100px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                        <p style="color: #999; font-style: italic;">é€‰æ‹©æ—¥æœŸåæ˜¾ç¤ºBMIæŒ‡æ•°...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="history-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ“‹ å†å²è®°å½•</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="clearData()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); font-size: 0.9em; padding: 10px 20px;">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
                    <button class="btn" onclick="exportData()" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); font-size: 0.9em; padding: 10px 20px;">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                    <button class="btn" onclick="document.getElementById('importFileInput').click()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); font-size: 0.9em; padding: 10px 20px;">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="importFileInput" accept=".json" onchange="importData(event)" style="display: none;">
                </div>
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>ä½“é‡ (kg)</th>
                        <th>é£Ÿç‰©è¯¦æƒ…</th>
                        <th>è¿åŠ¨è¯¦æƒ…</th>
                        <th>æ€»æ‘„å…¥ (kcal)</th>
                        <th>æ€»æ¶ˆè€— (kcal)</th>
                        <th>å¡è·¯é‡Œå¹³è¡¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
            </table>
        </div>

        <div class="history-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ“ å›´åº¦å†å²è®°å½•</h3>
                <button class="btn" onclick="clearMeasurements()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); font-size: 0.9em; padding: 10px 20px;">ğŸ—‘ï¸ æ¸…ç©ºå›´åº¦</button>
                <button class="btn" onclick="exportMeasurements()" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); font-size: 0.9em; padding: 10px 20px;">ğŸ“¤ å¯¼å‡ºå›´åº¦</button>
                <button class="btn" onclick="document.getElementById('importMeasurementsInput').click()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); font-size: 0.9em; padding: 10px 20px;">ğŸ“¥ å¯¼å…¥å›´åº¦</button>
                <input type="file" id="importMeasurementsInput" accept=".json" onchange="importMeasurements(event)" style="display: none;">
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>èƒ¸å›´ (cm)</th>
                        <th>è…°å›´ (cm)</th>
                        <th>è‡‚å›´ (cm)</th>
                        <th>è…¿å›´ (cm)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="measurementTableBody">
                </tbody>
            </table>
        </div>

        <div class="charts-section">
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h3>ğŸ“ å›´åº¦è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="measurementLineChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h3>ğŸ“Š ä½“é‡ä¸èƒ½é‡å¹³è¡¡å…³ç³»</h3>
                <div class="chart-container">
                    <canvas id="weightBalanceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="history-section">
            <h3>ğŸ¤– AI æ•´ä½“æ•°æ®åˆ†æ</h3>
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 10px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">ğŸ“ è‡ªå®šä¹‰åˆ†ææç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="customAnalysisPrompt" placeholder="ä¾‹å¦‚ï¼šè¯·é‡ç‚¹å…³æ³¨æˆ‘çš„é¥®é£Ÿç»“æ„æ˜¯å¦å‡è¡¡..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.95em; font-family: inherit; resize: vertical; background: white;"></textarea>
                <button class="btn" onclick="saveCustomAnalysisPrompt()" style="margin-top: 10px; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); padding: 10px; font-size: 0.9em;">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
            </div>
            <div id="overallAnalysis" style="min-height: 150px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 15px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                <p style="color: #999; font-style: italic;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–AIæ•´ä½“æ•°æ®åˆ†æ...</p>
            </div>
            <button class="btn" onclick="analyzeOverallData()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1em; padding: 15px;">ğŸ¤– åˆ†ææ•´ä½“æ•°æ®</button>
        </div>

        <div class="history-section">
            <h3>ğŸ¤– AI æ™ºèƒ½é—®ç­”</h3>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">ğŸ’¬ æé—®ï¼ˆAIå°†åŸºäºä½ çš„æ‰€æœ‰å¥åº·æ•°æ®ï¼ŒåŒ…æ‹¬ä½“é‡ã€é¥®é£Ÿã€è¿åŠ¨å’Œå›´åº¦æ•°æ®å›ç­”ï¼‰</label>
                <textarea id="aiQuestion" placeholder="ä¾‹å¦‚ï¼šæˆ‘è¿™å‘¨çš„å¹³å‡å¡è·¯é‡Œæ‘„å…¥æ˜¯å¤šå°‘ï¼Ÿæˆ‘çš„ä½“é‡å˜åŒ–è¶‹åŠ¿å¦‚ä½•ï¼Ÿæˆ‘çš„è…°å›´åœ¨å‡å°‘å—ï¼Ÿå¦‚æœæˆ‘æƒ³å‡è„‚ï¼Œåº”è¯¥æ€ä¹ˆè°ƒæ•´é¥®é£Ÿå’Œè¿åŠ¨ï¼Ÿèƒ¸å›´å’Œè‡‚å›´çš„å˜åŒ–è¯´æ˜ä»€ä¹ˆï¼Ÿ" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.95em; font-family: inherit; resize: vertical; background: white;"></textarea>
                <button class="btn" onclick="askAIQuestion()" style="margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ¤– æé—®</button>
            </div>
            <div id="aiAnswer" style="min-height: 150px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 15px; border-left: 4px solid #667eea;">
                <p style="color: #999; font-style: italic;">è¾“å…¥ä½ çš„é—®é¢˜ï¼ŒAIå°†åŸºäºä½ çš„æ‰€æœ‰å¥åº·æ•°æ®ï¼ˆåŒ…æ‹¬ä½“é‡ã€é¥®é£Ÿã€è¿åŠ¨å’Œå›´åº¦ï¼‰ä¸ºä½ è§£ç­”...</p>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let healthData = JSON.parse(localStorage.getItem('healthData')) || [];

        // å›¾è¡¨å®ä¾‹
        let nutritionPieChart, caloriesLineChart, weightLineChart, weightBalanceChart, measurementsLineChart;
        let measurements = [];

        // è§£æåçš„è¥å…»æ•°æ®
        let parsedNutrition = null;

        // è§£æåçš„è¿åŠ¨å¡è·¯é‡Œ
        let parsedExerciseCalories = null;

        // æ˜¯å¦æ˜¾ç¤ºå•ä¸ªåˆ é™¤æŒ‰é’®
        let showDeleteButtons = false;

        // åˆ‡æ¢æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        function toggleShowDeleteButtons() {
            showDeleteButtons = !showDeleteButtons;
            updateHistoryTable();
        }

        // åˆå§‹åŒ–æ—¥æœŸ
        function initDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('weightDate').value = today;
            document.getElementById('measureDate').value = today;
            document.getElementById('dietDate').value = today;
            document.getElementById('exerciseDate').value = today;
            document.getElementById('nutritionDate').value = today;
            document.getElementById('bmiDate').value = today;

            // åŠ è½½ä¿å­˜çš„é…ç½®
            const savedApiKey = localStorage.getItem('openaiApiKey');
            const savedEndpoint = localStorage.getItem('apiEndpoint');
            const savedModel = localStorage.getItem('modelName');

            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
            if (savedEndpoint) {
                document.getElementById('apiEndpoint').value = savedEndpoint;
            } else {
                // é¢„è®¾é»˜è®¤ç«¯ç‚¹ï¼ˆå·²æµ‹è¯•æˆåŠŸï¼‰
                document.getElementById('apiEndpoint').value = 'https://vg.v1api.cc/v1';
            }
            if (savedModel) {
                document.getElementById('modelName').value = savedModel;
            } else {
                // é¢„è®¾é»˜è®¤æ¨¡å‹
                document.getElementById('modelName').value = 'gpt-4o-mini';
            }

            // ä¿å­˜é»˜è®¤é…ç½®
            if (!localStorage.getItem('openaiApiKey')) {
                localStorage.setItem('openaiApiKey', 'sk-C8grNelZw3iKAR3C3Vu88CnbqpOMrUCB5d5pFbUpIkZjB37W');
            }
            if (!localStorage.getItem('apiEndpoint')) {
                localStorage.setItem('apiEndpoint', 'https://vg.v1api.cc/v1');
            }
            if (!localStorage.getItem('modelName')) {
                localStorage.setItem('modelName', 'gpt-4o-mini');
            }

            // åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰åˆ†ææç¤ºè¯
            const savedPrompt = localStorage.getItem('customAnalysisPrompt');
            if (savedPrompt) {
                document.getElementById('customAnalysisPrompt').value = savedPrompt;
            }

            // åŠ è½½ä¿å­˜çš„èº«é«˜ã€å¹´é¾„ã€æ€§åˆ«é»˜è®¤å€¼
            const savedHeight = localStorage.getItem('defaultHeight');
            const savedAge = localStorage.getItem('defaultAge');
            const savedGender = localStorage.getItem('defaultGender');

            if (savedHeight) {
                document.getElementById('heightValue').value = savedHeight;
            }
            if (savedAge) {
                document.getElementById('ageValue').value = savedAge;
            }
            if (savedGender) {
                document.getElementById('genderValue').value = savedGender;
            }

            // åŠ è½½å›´åº¦æ•°æ®
            const savedMeasurements = localStorage.getItem('measurements');
            if (savedMeasurements) {
                measurements = JSON.parse(savedMeasurements);
            }

            // æ›´æ–°å›´åº¦è¡¨æ ¼å’Œå›¾è¡¨
            updateMeasurementTable();
            updateMeasurementLineChart();
        }

        // è®¡ç®—BMI
        function calculateBMI() {
            const height = parseFloat(document.getElementById('heightValue').value);
            const weight = parseFloat(document.getElementById('weightValue').value);
            const age = parseInt(document.getElementById('ageValue').value) || 30;
            const gender = document.getElementById('genderValue').value || 'male';
            const bmiResultDiv = document.getElementById('bmiResult');

            if (height && weight) {
                const heightInMeters = height / 100;
                const bmi = weight / (heightInMeters * heightInMeters);
                const bmiRounded = bmi.toFixed(1);

                // è®¡ç®—ä½“è„‚ç‡ï¼ˆåŸºäºæ€§åˆ«ã€å¹´é¾„å’ŒBMIçš„æœ€æ–°å…¬å¼ï¼‰
                let bodyFatPercentage;
                if (gender === 'male') {
                    bodyFatPercentage = 1.20 * bmi + 0.23 * age - 16.2;
                } else {
                    bodyFatPercentage = 1.20 * bmi + 0.23 * age - 5.4;
                }
                const bodyFatRounded = bodyFatPercentage.toFixed(1);

                // æ ¹æ®ä½“è„‚ç‡å’Œæ€§åˆ«è¯„ä¼°èº«ä½“çŠ¶å†µ
                let status = '';
                let statusColor = '';
                let bodyFatStatus = '';
                
                // ä½¿ç”¨ä½“è„‚ç‡è¯„ä¼°ï¼ˆæ¯”å•çº¯BMIæ›´å‡†ç¡®ï¼‰
                if (gender === 'male') {
                    // ç”·æ€§ä½“è„‚ç‡æ ‡å‡†
                    if (bodyFatPercentage < 6) {
                        status = 'ä½“è„‚è¿‡ä½';
                        bodyFatStatus = 'å¿…éœ€è„‚è‚ªä»¥ä¸‹';
                        statusColor = '#9b59b6';
                    } else if (bodyFatPercentage < 14) {
                        status = 'åç˜¦';
                        bodyFatStatus = 'è¿åŠ¨å‘˜æ°´å¹³';
                        statusColor = '#3498db';
                    } else if (bodyFatPercentage < 18) {
                        status = 'æ­£å¸¸';
                        bodyFatStatus = 'å¥åº·æ°´å¹³';
                        statusColor = '#27ae60';
                    } else if (bodyFatPercentage < 25) {
                        status = 'åé«˜';
                        bodyFatStatus = 'å¯æ¥å—';
                        statusColor = '#f39c12';
                    } else {
                        status = 'è‚¥èƒ–';
                        bodyFatStatus = 'åé«˜æ°´å¹³';
                        statusColor = '#e74c3c';
                    }
                } else {
                    // å¥³æ€§ä½“è„‚ç‡æ ‡å‡†
                    if (bodyFatPercentage < 14) {
                        status = 'ä½“è„‚è¿‡ä½';
                        bodyFatStatus = 'å¿…éœ€è„‚è‚ªä»¥ä¸‹';
                        statusColor = '#9b59b6';
                    } else if (bodyFatPercentage < 21) {
                        status = 'åç˜¦';
                        bodyFatStatus = 'è¿åŠ¨å‘˜æ°´å¹³';
                        statusColor = '#3498db';
                    } else if (bodyFatPercentage < 25) {
                        status = 'æ­£å¸¸';
                        bodyFatStatus = 'å¥åº·æ°´å¹³';
                        statusColor = '#27ae60';
                    } else if (bodyFatPercentage < 32) {
                        status = 'åé«˜';
                        bodyFatStatus = 'å¯æ¥å—';
                        statusColor = '#f39c12';
                    } else {
                        status = 'è‚¥èƒ–';
                        bodyFatStatus = 'åé«˜æ°´å¹³';
                        statusColor = '#e74c3c';
                    }
                }

                document.getElementById('bmiValue').textContent = bmiRounded;
                document.getElementById('bmiStatus').textContent = status;
                document.getElementById('bmiStatus').style.color = statusColor;

                bmiResultDiv.style.display = 'block';
            } else {
                bmiResultDiv.style.display = 'none';
            }
        }

        // æ›´æ–°å½“å‰BMIæ˜¾ç¤º
        function updateCurrentBMI() {
            const currentBMIDiv = document.getElementById('currentBMI');
            const bmiDateInput = document.getElementById('bmiDate');
            
            // è·å–é€‰æ‹©çš„æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©åˆ™ä½¿ç”¨æœ€æ–°çš„æ—¥æœŸ
            let selectedDate = bmiDateInput.value;
            
            if (!selectedDate) {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œä½¿ç”¨æœ€æ–°çš„ä½“é‡è®°å½•æ—¥æœŸ
                const weightEntries = healthData.filter(entry => entry.weight !== null);
                if (weightEntries.length > 0) {
                    // æŒ‰æ—¥æœŸæ’åºï¼Œè·å–æœ€æ–°çš„
                    weightEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                    selectedDate = weightEntries[0].date;
                    bmiDateInput.value = selectedDate;
                } else {
                    // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    currentBMIDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="flex: 1;">
                                <p style="font-size: 1.2em; font-weight: 600; color: #999;">BMI æŒ‡æ•°ï¼š<span style="color: #999; font-size: 1.5em;"> --</span></p>
                                <p style="margin-top: 5px; color: #999;">èº«ä½“çŠ¶æ€ï¼š<span style="color: #999; font-weight: 600;">ç­‰å¾…æ•°æ®</span></p>
                            </div>
                            <div style="flex: 1;">
                                <p style="font-size: 1.1em; font-weight: 600; color: #999;">ä½“è„‚ç‡ï¼š<span style="color: #999; font-size: 1.4em;"> --</span></p>
                                <p style="margin-top: 5px; color: #999;">è„‚è‚ªç­‰çº§ï¼š<span style="color: #999; font-weight: 600;">ç­‰å¾…æ•°æ®</span></p>
                            </div>
                        </div>
                        <div style="background: rgba(153, 153, 153, 0.08); padding: 12px; border-radius: 8px; border-left: 3px solid #999; margin-top: 15px;">
                            <p style="font-size: 0.9em; color: #999; margin: 0;">ğŸ’¡ è¯·å…ˆæ·»åŠ ä½“é‡è®°å½•ï¼Œç„¶åé€‰æ‹©æ—¥æœŸæŸ¥çœ‹BMIæŒ‡æ•°ã€‚</p>
                        </div>
                    `;
                    return;
                }
            }
            
            // ä»healthDataä¸­æŸ¥æ‰¾è¯¥æ—¥æœŸçš„è®°å½•
            const entry = healthData.find(e => e.date === selectedDate);
            
            if (!entry || !entry.weight) {
                // å¦‚æœè¯¥æ—¥æœŸæ²¡æœ‰ä½“é‡æ•°æ®
                currentBMIDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="flex: 1;">
                            <p style="font-size: 1.2em; font-weight: 600; color: #999;">BMI æŒ‡æ•°ï¼š<span style="color: #999; font-size: 1.5em;"> --</span></p>
                            <p style="margin-top: 5px; color: #999;">èº«ä½“çŠ¶æ€ï¼š<span style="color: #999; font-weight: 600;">æ— æ•°æ®</span></p>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-size: 1.1em; font-weight: 600; color: #999;">ä½“è„‚ç‡ï¼š<span style="color: #999; font-size: 1.4em;"> --</span></p>
                            <p style="margin-top: 5px; color: #999;">è„‚è‚ªç­‰çº§ï¼š<span style="color: #999; font-weight: 600;">æ— æ•°æ®</span></p>
                        </div>
                    </div>
                    <div style="background: rgba(153, 153, 153, 0.08); padding: 12px; border-radius: 8px; border-left: 3px solid #999; margin-top: 15px;">
                        <p style="font-size: 0.9em; color: #999; margin: 0;">ğŸ’¡ ${selectedDate} æ²¡æœ‰ä½“é‡è®°å½•ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¥æœŸæˆ–æ·»åŠ è¯¥æ—¥æœŸçš„ä½“é‡è®°å½•ã€‚</p>
                    </div>
                `;
                return;
            }
            
            // ä½¿ç”¨è®°å½•ä¸­çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const weight = entry.weight;
            const height = entry.height || parseFloat(document.getElementById('heightValue').value) || 170;
            const age = entry.age || parseInt(document.getElementById('ageValue').value) || 30;
            const gender = entry.gender || document.getElementById('genderValue').value || 'male';
            
            // è®¡ç®—BMI
            const heightInMeters = height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);
            const bmiRounded = bmi.toFixed(1);

            // è®¡ç®—ä½“è„‚ç‡ï¼ˆåŸºäºæ€§åˆ«ã€å¹´é¾„å’ŒBMIçš„æœ€æ–°å…¬å¼ï¼‰
            let bodyFatPercentage;
            if (gender === 'male') {
                bodyFatPercentage = 1.20 * bmi + 0.23 * age - 16.2;
            } else {
                bodyFatPercentage = 1.20 * bmi + 0.23 * age - 5.4;
            }
            const bodyFatRounded = bodyFatPercentage.toFixed(1);

            // æ ¹æ®ä½“è„‚ç‡å’Œæ€§åˆ«è¯„ä¼°èº«ä½“çŠ¶å†µ
            let status = '';
            let statusColor = '';
            let bodyFatStatus = '';
            let advice = '';

            if (gender === 'male') {
                // ç”·æ€§ä½“è„‚ç‡æ ‡å‡†
                if (bodyFatPercentage < 6) {
                    status = 'ä½“è„‚è¿‡ä½';
                    bodyFatStatus = 'å¿…éœ€è„‚è‚ªä»¥ä¸‹';
                    statusColor = '#9b59b6';
                    advice = 'ä½“è„‚ç‡è¿‡ä½å¯èƒ½å½±å“å¥åº·ï¼Œå»ºè®®å¢åŠ å¥åº·è„‚è‚ªæ‘„å…¥å’Œé€‚åº¦åŠ›é‡è®­ç»ƒã€‚';
                } else if (bodyFatPercentage < 14) {
                    status = 'åç˜¦';
                    bodyFatStatus = 'è¿åŠ¨å‘˜æ°´å¹³';
                    statusColor = '#3498db';
                    advice = 'æ‚¨æ‹¥æœ‰ç†æƒ³çš„è¿åŠ¨ä½“å‹ï¼Œç»§ç»­ä¿æŒã€‚å»ºè®®ç¡®ä¿å……è¶³çš„è¥å…»æ‘„å…¥ã€‚';
                } else if (bodyFatPercentage < 18) {
                    status = 'æ­£å¸¸';
                    bodyFatStatus = 'å¥åº·æ°´å¹³';
                    statusColor = '#27ae60';
                    advice = 'æ‚¨çš„ä½“è„‚ç‡å¤„äºå¥åº·èŒƒå›´ï¼Œç»§ç»­ä¿æŒå‡è¡¡é¥®é£Ÿå’Œè§„å¾‹è¿åŠ¨ã€‚';
                } else if (bodyFatPercentage < 25) {
                    status = 'åé«˜';
                    bodyFatStatus = 'å¯æ¥å—';
                    statusColor = '#f39c12';
                    advice = 'ä½“è„‚ç‡ç¨é«˜ï¼Œå»ºè®®å¢åŠ æœ‰æ°§è¿åŠ¨ï¼Œæ§åˆ¶é¥®é£Ÿä¸­çš„çƒ­é‡æ‘„å…¥ã€‚';
                } else {
                    status = 'è‚¥èƒ–';
                    bodyFatStatus = 'åé«˜æ°´å¹³';
                    statusColor = '#e74c3c';
                    advice = 'ä½“è„‚ç‡åé«˜ï¼Œå»ºè®®åˆ¶å®šå‡è„‚è®¡åˆ’ï¼ŒåŒ…æ‹¬é¥®é£Ÿæ§åˆ¶å’Œè§„å¾‹è¿åŠ¨ã€‚å¯å’¨è¯¢ä¸“ä¸šè¥å…»å¸ˆã€‚';
                }
            } else {
                // å¥³æ€§ä½“è„‚ç‡æ ‡å‡†
                if (bodyFatPercentage < 14) {
                    status = 'ä½“è„‚è¿‡ä½';
                    bodyFatStatus = 'å¿…éœ€è„‚è‚ªä»¥ä¸‹';
                    statusColor = '#9b59b6';
                    advice = 'ä½“è„‚ç‡è¿‡ä½å¯èƒ½å½±å“å†…åˆ†æ³Œå¥åº·ï¼Œå»ºè®®é€‚å½“å¢åŠ å¥åº·è„‚è‚ªæ‘„å…¥ã€‚';
                } else if (bodyFatPercentage < 21) {
                    status = 'åç˜¦';
                    bodyFatStatus = 'è¿åŠ¨å‘˜æ°´å¹³';
                    statusColor = '#3498db';
                    advice = 'æ‚¨æ‹¥æœ‰ç†æƒ³çš„è¿åŠ¨ä½“å‹ï¼Œç»§ç»­ä¿æŒã€‚å»ºè®®ç¡®ä¿å……è¶³çš„è¥å…»æ‘„å…¥ã€‚';
                } else if (bodyFatPercentage < 25) {
                    status = 'æ­£å¸¸';
                    bodyFatStatus = 'å¥åº·æ°´å¹³';
                    statusColor = '#27ae60';
                    advice = 'æ‚¨çš„ä½“è„‚ç‡å¤„äºå¥åº·èŒƒå›´ï¼Œç»§ç»­ä¿æŒå‡è¡¡é¥®é£Ÿå’Œè§„å¾‹è¿åŠ¨ã€‚';
                } else if (bodyFatPercentage < 32) {
                    status = 'åé«˜';
                    bodyFatStatus = 'å¯æ¥å—';
                    statusColor = '#f39c12';
                    advice = 'ä½“è„‚ç‡ç¨é«˜ï¼Œå»ºè®®å¢åŠ æœ‰æ°§è¿åŠ¨ï¼Œæ§åˆ¶é¥®é£Ÿä¸­çš„çƒ­é‡æ‘„å…¥ã€‚';
                } else {
                    status = 'è‚¥èƒ–';
                    bodyFatStatus = 'åé«˜æ°´å¹³';
                    statusColor = '#e74c3c';
                    advice = 'ä½“è„‚ç‡åé«˜ï¼Œå»ºè®®åˆ¶å®šå‡è„‚è®¡åˆ’ï¼ŒåŒ…æ‹¬é¥®é£Ÿæ§åˆ¶å’Œè§„å¾‹è¿åŠ¨ã€‚å¯å’¨è¯¢ä¸“ä¸šè¥å…»å¸ˆã€‚';
                }
            }

            currentBMIDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <p style="font-size: 1.2em; font-weight: 600; color: #667eea;">BMI æŒ‡æ•°ï¼š<span style="color: ${statusColor}; font-size: 1.5em;"> ${bmiRounded}</span></p>
                            <p style="margin-top: 5px; color: #555;">èº«ä½“çŠ¶æ€ï¼š<span style="color: ${statusColor}; font-weight: 600;">${status}</span></p>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <p style="font-size: 1.1em; font-weight: 600; color: #e67e22;">ä½“è„‚ç‡ï¼š<span style="color: ${statusColor}; font-size: 1.4em;"> ${bodyFatRounded}%</span></p>
                            <p style="margin-top: 5px; color: #555;">è„‚è‚ªç­‰çº§ï¼š<span style="color: ${statusColor}; font-weight: 600;">${bodyFatStatus}</span></p>
                        </div>
                    </div>
                    <div style="background: rgba(102, 126, 234, 0.08); padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                        <p style="font-size: 0.9em; color: #666; margin: 0;"><strong>ğŸ’¡ å»ºè®®ï¼š</strong>${advice}</p>
                    </div>
                    <div style="font-size: 0.75em; color: #999; padding-top: 10px; border-top: 1px dashed #e0e0e0;">
                        <p style="margin: 0;">* æ•°æ®æ—¥æœŸï¼š${selectedDate}</p>
                        <p style="margin: 5px 0 0 0;">* ä½“è„‚ç‡è®¡ç®—å…¬å¼ï¼ˆ${gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}ï¼‰ï¼š1.20 Ã— BMI + 0.23 Ã— å¹´é¾„ ${gender === 'male' ? '- 16.2' : '- 5.4'}</p>
                        <p style="margin: 5px 0 0 0;">* åŸºäºDeurenbergç­‰äººç ”ç©¶çš„æœ€æ–°ä½“è„‚ç‡è¯„ä¼°æ–¹æ³•</p>
                    </div>
                </div>
            `;
        }

        // åŒæ­¥æ‰€æœ‰æ—¥æœŸé€‰æ‹©å™¨
        function syncDates(sourceDateInput) {
            const selectedDate = sourceDateInput.value;
            const allDateInputs = ['nlDateInput', 'weightDate', 'measureDate', 'dietDate', 'exerciseDate', 'nutritionDate', 'bmiDate'];

            allDateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && input.id !== sourceDateInput.id) {
                    input.value = selectedDate;
                }
            });

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡å’Œè¥å…»åˆ†æ
            updateStatsForDate(selectedDate);
            updateNutritionPieChartForDate();

            // å¦‚æœæ˜¯BMIæ—¥æœŸå˜åŒ–ï¼Œæ›´æ–°BMIæ˜¾ç¤º
            if (sourceDateInput.id === 'bmiDate') {
                updateCurrentBMI();
            }
        }

        // å¿«é€Ÿé€‰æ‹©é£Ÿç‰©
        function quickSelectFood(food) {
            const foodInput = document.getElementById('foodDescription');
            if (foodInput.value) {
                foodInput.value += 'ï¼Œ' + food;
            } else {
                foodInput.value = food;
            }
        }

        // å¿«é€Ÿé€‰æ‹©è¿åŠ¨
        function quickSelectExercise(exercise) {
            const exerciseInput = document.getElementById('exerciseDescription');
            if (exerciseInput.value) {
                exerciseInput.value += 'ï¼Œ' + exercise;
            } else {
                exerciseInput.value = exercise;
            }
        }

        // è‡ªç„¶è¯­è¨€è§£æ
        async function parseNaturalLanguage() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';
            const input = document.getElementById('naturalLanguageInput').value.trim();

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            if (!input) {
                alert('è¯·è¾“å…¥è‡ªç„¶è¯­è¨€æè¿°');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span>æ­£åœ¨è§£æ...';
            btn.disabled = true;

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªå¥åº·è®°å½•åŠ©æ‰‹ã€‚è¯·è§£æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è¾“å…¥ï¼Œæå–ä½“é‡ã€é£Ÿç‰©ã€è¿åŠ¨å’Œå›´åº¦ä¿¡æ¯ã€‚å¯¹äºé£Ÿç‰©ï¼Œå¿…é¡»æ ¹æ®é£Ÿç‰©åç§°å’Œé‡é‡è‡ªåŠ¨è®¡ç®—è›‹ç™½è´¨ã€è„‚è‚ªã€ç¢³æ°´åŒ–åˆç‰©å’Œå¡è·¯é‡Œã€‚åªè¿”å›JSONæ ¼å¼ï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—ã€‚'
                            },
                            {
                                role: 'user',
                                content: `è¯·è§£æä»¥ä¸‹å†…å®¹ï¼Œè¿”å›JSONæ ¼å¼ï¼š\n${input}\n\nè¿”å›æ ¼å¼ï¼š\n{\n  "weight": ä½“é‡æ•°å­—(å¦‚æœæ²¡æœ‰åˆ™ä¸ºnull),\n  "foods": [{\n    "name": "é£Ÿç‰©åç§°",\n    "description": "é£Ÿç‰©æè¿°(åŒ…å«é‡é‡)",\n    "protein": è›‹ç™½è´¨å…‹æ•°(æ ¹æ®é£Ÿç‰©å’Œé‡é‡è®¡ç®—),\n    "fat": è„‚è‚ªå…‹æ•°(æ ¹æ®é£Ÿç‰©å’Œé‡é‡è®¡ç®—),\n    "carbs": ç¢³æ°´å…‹æ•°(æ ¹æ®é£Ÿç‰©å’Œé‡é‡è®¡ç®—),\n    "calories": å¡è·¯é‡Œ(æ ¹æ®é£Ÿç‰©å’Œé‡é‡è®¡ç®—)\n  }],\n  "exercises": [{\n    "description": "è¿åŠ¨æè¿°",\n    "calories": æ¶ˆè€—å¡è·¯é‡Œ\n  }],\n  "measurements": {\n    "chest": èƒ¸å›´æ•°å­—(å•ä½cmï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºnull),\n    "waist": è…°å›´æ•°å­—(å•ä½cmï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºnull),\n    "arm": è‡‚å›´æ•°å­—(å•ä½cmï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºnull),\n    "leg": è…¿å›´æ•°å­—(å•ä½cmï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºnull)\n  }\n}\n\né‡è¦ï¼šå¯¹äºé£Ÿç‰©ï¼Œå¿…é¡»æ ¹æ®é£Ÿç‰©è¥å…»æˆåˆ†è¡¨å’Œå®é™…é‡é‡è®¡ç®—å‡†ç¡®çš„è›‹ç™½è´¨ã€è„‚è‚ªã€ç¢³æ°´åŒ–åˆç‰©å’Œå¡è·¯é‡Œæ•°å€¼ï¼Œä¸èƒ½ä¸ºnullã€‚\n\nå›´åº¦å…³é”®è¯ï¼šèƒ¸å›´ã€è…°å›´ã€è‡‚å›´ã€è…¿å›´ï¼Œå•ä½æ˜¯cmã€‚\n\nå¦‚æœæŸé¡¹æ²¡æœ‰åˆ™ä¸ºnullæˆ–ç©ºæ•°ç»„ã€‚`
                            }
                        ],
                        temperature: 0.3
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const content = data.choices[0].message.content;
                const result = JSON.parse(content);

                // è·å–é€‰æ‹©çš„æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©åˆ™ä½¿ç”¨ä»Šå¤©
                const selectedDate = document.getElementById('nlDateInput').value;
                const today = selectedDate || new Date().toISOString().split('T')[0];

                // æ·»åŠ ä½“é‡
                if (result.weight !== null) {
                    const existingEntry = healthData.find(entry => entry.date === today);
                    if (existingEntry) {
                        existingEntry.weight = result.weight;
                    } else {
                        healthData.push({
                            date: today,
                            weight: result.weight,
                            diet: null,
                            exercise: null
                        });
                    }
                }

                // æ·»åŠ é£Ÿç‰©
                if (result.foods && result.foods.length > 0) {
                    let totalProtein = 0, totalFat = 0, totalCarbs = 0, totalCalories = 0;
                    result.foods.forEach(food => {
                        totalProtein += food.protein || 0;
                        totalFat += food.fat || 0;
                        totalCarbs += food.carbs || 0;
                        totalCalories += food.calories || 0;
                    });

                    const existingEntry = healthData.find(entry => entry.date === today);
                    if (existingEntry) {
                        if (!existingEntry.diet) {
                            existingEntry.diet = { protein: totalProtein, fat: totalFat, carbs: totalCarbs, calories: totalCalories, foodItems: [] };
                        }
                        existingEntry.diet.protein += totalProtein;
                        existingEntry.diet.fat += totalFat;
                        existingEntry.diet.carbs += totalCarbs;
                        existingEntry.diet.calories += totalCalories;
                        result.foods.forEach(food => {
                            existingEntry.diet.foodItems.push({
                                description: food.name || food.description || 'æœªçŸ¥é£Ÿç‰©',
                                protein: food.protein || 0,
                                fat: food.fat || 0,
                                carbs: food.carbs || 0,
                                calories: food.calories || 0
                            });
                        });
                    } else {
                        healthData.push({
                            date: today,
                            weight: null,
                            diet: { protein: totalProtein, fat: totalFat, carbs: totalCarbs, calories: totalCalories, foodItems: result.foods.map(food => ({ description: food.name || food.description || 'æœªçŸ¥é£Ÿç‰©', protein: food.protein || 0, fat: food.fat || 0, carbs: food.carbs || 0, calories: food.calories || 0 })) },
                            exercise: null
                        });
                    }
                }

                // æ·»åŠ è¿åŠ¨
                if (result.exercises && result.exercises.length > 0) {
                    let totalCalories = 0;
                    result.exercises.forEach(exercise => {
                        totalCalories += exercise.calories || 0;
                    });

                    const existingEntry = healthData.find(entry => entry.date === today);
                    if (existingEntry) {
                        if (!existingEntry.exercise) {
                            existingEntry.exercise = { calories: 0, exerciseItems: [] };
                        }
                        existingEntry.exercise.calories += totalCalories;
                        result.exercises.forEach(exercise => {
                            existingEntry.exercise.exerciseItems.push({
                                description: exercise.description,
                                calories: exercise.calories || 0
                            });
                        });
                    } else {
                        healthData.push({
                            date: today,
                            weight: null,
                            diet: null,
                            exercise: { calories: totalCalories, exerciseItems: result.exercises.map(exercise => ({ description: exercise.description, calories: exercise.calories || 0 })) }
                        });
                    }
                }

                // æ·»åŠ å›´åº¦æ•°æ®
                if (result.measurements) {
                    const chest = result.measurements.chest;
                    const waist = result.measurements.waist;
                    const arm = result.measurements.arm;
                    const leg = result.measurements.leg;

                    if (chest !== null || waist !== null || arm !== null || leg !== null) {
                        const existingEntry = measurements.find(entry => entry.date === today);
                        if (existingEntry) {
                            existingEntry.chest = chest !== null ? chest : existingEntry.chest;
                            existingEntry.waist = waist !== null ? waist : existingEntry.waist;
                            existingEntry.arm = arm !== null ? arm : existingEntry.arm;
                            existingEntry.leg = leg !== null ? leg : existingEntry.leg;
                        } else {
                            measurements.push({
                                date: today,
                                chest: chest,
                                waist: waist,
                                arm: arm,
                                leg: leg
                            });
                        }
                        saveMeasurements();
                        updateMeasurementTable();
                        updateMeasurementLineChart();
                    }
                }

                saveData();
                updateUI();

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('naturalLanguageInput').value = '';

                // æ˜¾ç¤ºè¯¦ç»†æˆåŠŸæ¶ˆæ¯
                let message = 'âœ… è§£ææˆåŠŸï¼\n\n';
                if (result.weight !== null) message += `ğŸ“Š ä½“é‡ï¼š${result.weight}kg\n\n`;
                if (result.measurements) {
                    let hasMeasurement = false;
                    message += 'ğŸ“ å›´åº¦è¯¦æƒ…ï¼š\n';
                    if (result.measurements.chest !== null) {
                        message += `â€¢ èƒ¸å›´ï¼š${result.measurements.chest}cm\n`;
                        hasMeasurement = true;
                    }
                    if (result.measurements.waist !== null) {
                        message += `â€¢ è…°å›´ï¼š${result.measurements.waist}cm\n`;
                        hasMeasurement = true;
                    }
                    if (result.measurements.arm !== null) {
                        message += `â€¢ è‡‚å›´ï¼š${result.measurements.arm}cm\n`;
                        hasMeasurement = true;
                    }
                    if (result.measurements.leg !== null) {
                        message += `â€¢ è…¿å›´ï¼š${result.measurements.leg}cm\n`;
                        hasMeasurement = true;
                    }
                    if (hasMeasurement) message += `\n`;
                    else message = 'âœ… è§£ææˆåŠŸï¼\n\n'; // å¦‚æœæ²¡æœ‰å›´åº¦æ•°æ®ï¼Œç§»é™¤å›´åº¦æ ‡é¢˜
                }
                if (result.foods && result.foods.length > 0) {
                    message += 'ğŸ½ï¸ é£Ÿç‰©è¯¦æƒ…ï¼š\n';
                    result.foods.forEach(food => {
                        const foodName = food.name || food.description || 'æœªçŸ¥é£Ÿç‰©';
                        message += `â€¢ ${foodName}\n`;
                        message += `  è›‹ç™½è´¨ï¼š${food.protein || 0}g\n`;
                        message += `  è„‚è‚ªï¼š${food.fat || 0}g\n`;
                        message += `  ç¢³æ°´ï¼š${food.carbs || 0}g\n`;
                        message += `  å¡è·¯é‡Œï¼š${food.calories || 0}kcal\n`;
                    });
                    message += `\n`;
                }
                if (result.exercises && result.exercises.length > 0) {
                    message += 'ğŸ’ª è¿åŠ¨è¯¦æƒ…ï¼š\n';
                    result.exercises.forEach(exercise => {
                        message += `â€¢ ${exercise.description} - æ¶ˆè€—ï¼š${exercise.calories || 0}kcal\n`;
                    });
                    message += `\n`;
                }
                alert(message);

            } catch (error) {
                console.error('è§£æå¤±è´¥:', error);
                alert('âŒ è§£æå¤±è´¥ï¼š' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ä¿å­˜APIé…ç½®
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const modelName = document.getElementById('modelName').value.trim();

            if (!apiKey) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
                return;
            }

            localStorage.setItem('openaiApiKey', apiKey);
            if (apiEndpoint) {
                localStorage.setItem('apiEndpoint', apiEndpoint);
            } else {
                localStorage.removeItem('apiEndpoint');
            }
            if (modelName) {
                localStorage.setItem('modelName', modelName);
            } else {
                localStorage.removeItem('modelName');
            }

            alert('é…ç½®å·²ä¿å­˜ï¼');
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';

            if (!apiKey) {
                alert('è¯·å…ˆä¿å­˜ API Key');
                return;
            }

            alert('æ­£åœ¨æµ‹è¯•è¿æ¥...\nAPIç«¯ç‚¹ï¼š' + apiEndpoint + '\næ¨¡å‹ï¼š' + modelName);

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'user',
                                content: 'æµ‹è¯•è¿æ¥'
                            }
                        ],
                        max_tokens: 10
                    })
                });

                const data = await response.json();

                if (data.error) {
                    alert('âŒ è¿æ¥å¤±è´¥ï¼š\n' + data.error.message);
                } else {
                    alert('âœ… è¿æ¥æˆåŠŸï¼APIé…ç½®æ­£ç¡®ã€‚');
                }
            } catch (error) {
                alert('âŒ è¿æ¥å¤±è´¥ï¼š\n' + error.message + '\n\nè¯·æ£€æŸ¥ï¼š\n1. API Keyæ˜¯å¦æ­£ç¡®\n2. APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
            }
        }

        // ä¿å­˜è‡ªå®šä¹‰åˆ†ææç¤ºè¯
        function saveCustomAnalysisPrompt() {
            const prompt = document.getElementById('customAnalysisPrompt').value.trim();
            if (prompt) {
                localStorage.setItem('customAnalysisPrompt', prompt);
                alert('âœ… æç¤ºè¯å·²ä¿å­˜ï¼');
            } else {
                localStorage.removeItem('customAnalysisPrompt');
                alert('âœ… æç¤ºè¯å·²æ¸…ç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤æç¤ºè¯ã€‚');
            }
        }

        // åˆ‡æ¢é¥®é£Ÿè¾“å…¥æ¨¡å¼
        function toggleDietInputMode() {
            const mode = document.getElementById('dietInputMode').value;
            document.getElementById('smartDietInput').style.display = mode === 'smart' ? 'block' : 'none';
            document.getElementById('manualDietInput').style.display = mode === 'manual' ? 'block' : 'none';
            parsedNutrition = null;
            document.getElementById('foodAnalysisResult').style.display = 'none';
        }

        // åˆ‡æ¢è¿åŠ¨è¾“å…¥æ¨¡å¼
        function toggleExerciseInputMode() {
            const mode = document.getElementById('exerciseInputMode').value;
            document.getElementById('smartExerciseInput').style.display = mode === 'smart' ? 'block' : 'none';
            document.getElementById('manualExerciseInput').style.display = mode === 'manual' ? 'block' : 'none';
            parsedExerciseCalories = null;
            document.getElementById('exerciseCaloriesResult').style.display = 'none';
        }

        // AI è§£æé£Ÿç‰©è¥å…»æˆåˆ†
        async function analyzeFood() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';
            const foodDescription = document.getElementById('foodDescription').value.trim();

            if (!apiKey) {
                alert('è¯·å…ˆè®¾ç½® API Key');
                return;
            }

            if (!foodDescription) {
                alert('è¯·è¾“å…¥é£Ÿç‰©æè¿°');
                return;
            }

            const resultDiv = document.getElementById('foodAnalysisResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨åˆ†æé£Ÿç‰©è¥å…»æˆåˆ†...</p>';

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªè¥å…»å­¦ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·è¾“å…¥çš„é£Ÿç‰©ï¼Œç²¾ç¡®è®¡ç®—è¥å…»æˆåˆ†ã€‚å¦‚æœæ˜¯å¤šä¸ªé£Ÿç‰©ï¼Œè¯·åˆ†åˆ«è¿”å›æ¯ä¸ªé£Ÿç‰©çš„è¥å…»æˆåˆ†ã€‚åªè¿”å›JSONæ ¼å¼ï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—ã€‚'
                            },
                            {
                                role: 'user',
                                content: `è¯·åˆ†æä»¥ä¸‹é£Ÿç‰©çš„è¥å…»æˆåˆ†ï¼Œè¿”å›JSONæ ¼å¼ï¼š\né£Ÿç‰©ï¼š${foodDescription}\n\nè¿”å›æ ¼å¼ï¼ˆæ”¯æŒå•ä¸ªæˆ–å¤šä¸ªé£Ÿç‰©ï¼‰ï¼š\n{\n  "foods": [\n    {\n      "name": "é£Ÿç‰©åç§°",\n      "description": "é£Ÿç‰©æè¿°(åŒ…å«é‡é‡)",\n      "protein": è›‹ç™½è´¨å…‹æ•°(æ•°å­—),\n      "fat": è„‚è‚ªå…‹æ•°(æ•°å­—),\n      "carbs": ç¢³æ°´åŒ–åˆç‰©å…‹æ•°(æ•°å­—),\n      "calories": å¡è·¯é‡Œ(æ•°å­—)\n    }\n  ]\n}\n\nå¦‚æœåªæœ‰ä¸€ä¸ªé£Ÿç‰©ï¼Œfoodsæ•°ç»„ä¸­åªåŒ…å«ä¸€ä¸ªå…ƒç´ ã€‚è¯·æ ¹æ®å®é™…é£Ÿç‰©è¥å…»æˆåˆ†å‡†ç¡®è®¡ç®—ã€‚`
                            }
                        ],
                        temperature: 0.3
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const content = data.choices[0].message.content;
                const nutritionData = JSON.parse(content);

                // ä¿å­˜è§£æç»“æœ
                parsedNutrition = nutritionData.foods;

                // è®¡ç®—æ€»è¥å…»
                const totalProtein = nutritionData.foods.reduce((sum, food) => sum + (food.protein || 0), 0);
                const totalFat = nutritionData.foods.reduce((sum, food) => sum + (food.fat || 0), 0);
                const totalCarbs = nutritionData.foods.reduce((sum, food) => sum + (food.carbs || 0), 0);
                const totalCalories = nutritionData.foods.reduce((sum, food) => sum + (food.calories || 0), 0);

                // æ˜¾ç¤ºç»“æœ
                let resultHTML = '<h4 style="color: #667eea; margin-bottom: 10px;">âœ… åˆ†æç»“æœ</h4>';
                nutritionData.foods.forEach((food, index) => {
                    resultHTML += `
                        <div style="background: rgba(102, 126, 234, 0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                            <p style="font-weight: 600; color: #667eea;">${food.name || food.description}</p>
                            <p>è›‹ç™½è´¨ï¼š${food.protein}g | è„‚è‚ªï¼š${food.fat}g | ç¢³æ°´ï¼š${food.carbs}g | å¡è·¯é‡Œï¼š${food.calories}kcal</p>
                        </div>
                    `;
                });
                resultHTML += `
                    <div style="background: rgba(39, 174, 96, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <p style="font-weight: 600; color: #27ae60;">æ€»è®¡ï¼šè›‹ç™½è´¨ ${totalProtein}g | è„‚è‚ª ${totalFat}g | ç¢³æ°´ ${totalCarbs}g | å¡è·¯é‡Œ ${totalCalories}kcal</p>
                    </div>
                    <p style="color: #27ae60; margin-top: 10px;">ç‚¹å‡»"æ·»åŠ é¥®é£Ÿ"æŒ‰é’®ä¿å­˜</p>
                `;
                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                resultDiv.innerHTML = `<p style="color: #e74c3c;">âŒ åˆ†æå¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // AI è®¡ç®—è¿åŠ¨å¡è·¯é‡Œ
        async function calculateExerciseCalories() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';
            const exerciseDescription = document.getElementById('exerciseDescription').value.trim();

            if (!apiKey) {
                alert('è¯·å…ˆè®¾ç½® API Key');
                return;
            }

            if (!exerciseDescription) {
                alert('è¯·è¾“å…¥è¿åŠ¨æè¿°');
                return;
            }

            const resultDiv = document.getElementById('exerciseCaloriesResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨è®¡ç®—æ¶ˆè€—å¡è·¯é‡Œ...</p>';

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªå¥èº«ä¸“å®¶ã€‚è¯·è®¡ç®—ç”¨æˆ·è¾“å…¥çš„è¿åŠ¨æ¶ˆè€—çš„å¡è·¯é‡Œã€‚å¦‚æœæ˜¯å¤šä¸ªè¿åŠ¨ï¼Œè¯·åˆ†åˆ«è¿”å›æ¯ä¸ªè¿åŠ¨çš„å¡è·¯é‡Œã€‚åªè¿”å›JSONæ ¼å¼ï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—ã€‚'
                            },
                            {
                                role: 'user',
                                content: `è¯·è®¡ç®—ä»¥ä¸‹è¿åŠ¨æ¶ˆè€—çš„å¡è·¯é‡Œï¼Œè¿”å›JSONæ ¼å¼ï¼š\nè¿åŠ¨ï¼š${exerciseDescription}\n\nè¿”å›æ ¼å¼ï¼ˆæ”¯æŒå•ä¸ªæˆ–å¤šä¸ªè¿åŠ¨ï¼‰ï¼š\n{\n  "exercises": [\n    {\n      "description": "è¿åŠ¨æè¿°",\n      "calories": æ¶ˆè€—å¡è·¯é‡Œ(æ•°å­—)\n    }\n  ]\n}\n\nå¦‚æœåªæœ‰ä¸€ä¸ªè¿åŠ¨ï¼Œexercisesæ•°ç»„ä¸­åªåŒ…å«ä¸€ä¸ªå…ƒç´ ã€‚è¯·æ ¹æ®è¿åŠ¨ç±»å‹å’Œæ—¶é•¿ç²¾ç¡®è®¡ç®—ï¼ˆæŒ‰70kgä½“é‡ä¼°ç®—ï¼‰ã€‚`
                            }
                        ],
                        temperature: 0.3
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const content = data.choices[0].message.content;
                const exerciseData = JSON.parse(content);

                // ä¿å­˜è§£æç»“æœ
                parsedExerciseCalories = exerciseData.exercises;

                // è®¡ç®—æ€»å¡è·¯é‡Œ
                const totalCalories = exerciseData.exercises.reduce((sum, exercise) => sum + (exercise.calories || 0), 0);

                // æ˜¾ç¤ºç»“æœ
                let resultHTML = '<h4 style="color: #667eea; margin-bottom: 10px;">âœ… è®¡ç®—ç»“æœ</h4>';
                exerciseData.exercises.forEach((exercise, index) => {
                    resultHTML += `
                        <div style="background: rgba(102, 126, 234, 0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                            <p style="font-weight: 600; color: #667eea;">${exercise.description}</p>
                            <p>æ¶ˆè€—å¡è·¯é‡Œï¼š${exercise.calories}kcal</p>
                        </div>
                    `;
                });
                resultHTML += `
                    <div style="background: rgba(39, 174, 96, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <p style="font-weight: 600; color: #27ae60;">æ€»è®¡æ¶ˆè€—ï¼š${totalCalories}kcal</p>
                    </div>
                    <p style="color: #27ae60; margin-top: 10px;">ç‚¹å‡»"æ·»åŠ è¿åŠ¨"æŒ‰é’®ä¿å­˜</p>
                `;
                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                console.error('è®¡ç®—å¤±è´¥:', error);
                resultDiv.innerHTML = `<p style="color: #e74c3c;">âŒ è®¡ç®—å¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // æ·»åŠ ä½“é‡è®°å½•
        function addWeight() {
            const date = document.getElementById('weightDate').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            const height = parseFloat(document.getElementById('heightValue').value);
            const age = parseInt(document.getElementById('ageValue').value);
            const gender = document.getElementById('genderValue').value;

            if (!date || !weight) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ä½“é‡ä¿¡æ¯');
                return;
            }

            const existingEntry = healthData.find(entry => entry.date === date);
            let previousWeight = null;

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„ä½“é‡è®°å½•
            if (existingEntry && existingEntry.weight) {
                previousWeight = existingEntry.weight;
            }

            if (existingEntry) {
                existingEntry.weight = weight;
                existingEntry.height = height || existingEntry.height;
                existingEntry.age = age || existingEntry.age;
                existingEntry.gender = gender || existingEntry.gender;
            } else {
                healthData.push({
                    date: date,
                    weight: weight,
                    height: height,
                    age: age,
                    gender: gender,
                    diet: null,
                    exercise: null
                });
            }

            saveData();

            // ä¿å­˜èº«é«˜ã€å¹´é¾„ã€æ€§åˆ«ä½œä¸ºé»˜è®¤å€¼
            if (height) {
                localStorage.setItem('defaultHeight', height);
            }
            if (age) {
                localStorage.setItem('defaultAge', age);
            }
            if (gender) {
                localStorage.setItem('defaultGender', gender);
            }

            updateUI();
            updateCurrentBMI();
            clearWeightInput();

            // æ£€æŸ¥ä½“é‡æ˜¯å¦å‡å°‘ï¼Œå¦‚æœå‡å°‘åˆ™åº†ç¥
            if (previousWeight && weight < previousWeight) {
                const weightLoss = (previousWeight - weight).toFixed(1);
                createFireworks();
                showCongratulations(`ä½ çš„ä½“é‡å‡å°‘äº† ${weightLoss}kgï¼<br>ç»§ç»­ä¿æŒï¼Œä½ åšå¾—å¾ˆå¥½ï¼`);
            }
        }

        // æ·»åŠ å›´åº¦è®°å½•
        function addMeasurement() {
            const date = document.getElementById('measureDate').value;
            const chest = parseFloat(document.getElementById('chestValue').value);
            const waist = parseFloat(document.getElementById('waistValue').value);
            const arm = parseFloat(document.getElementById('armValue').value);
            const leg = parseFloat(document.getElementById('legValue').value);

            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            if (!chest && !waist && !arm && !leg) {
                alert('è¯·è‡³å°‘å¡«å†™ä¸€é¡¹å›´åº¦æ•°æ®');
                return;
            }

            const existingEntry = measurements.find(entry => entry.date === date);
            let improvements = [];

            // è·å–æœ€è¿‘ä¸€æ¬¡çš„å›´åº¦è®°å½•ï¼ˆä¸é™æ—¥æœŸï¼‰
            const sortedMeasurements = [...measurements].sort((a, b) => new Date(b.date) - new Date(a.date));
            const lastMeasurement = sortedMeasurements.length > 0 ? sortedMeasurements[0] : null;

            // æ£€æŸ¥å›´åº¦å˜åŒ–ï¼ˆä¸æœ€è¿‘ä¸€æ¬¡è®°å½•æ¯”è¾ƒï¼‰
            if (lastMeasurement && lastMeasurement.date !== date) {
                if (chest && lastMeasurement.chest && chest < lastMeasurement.chest) {
                    improvements.push(`èƒ¸å›´å‡å°‘äº† ${(lastMeasurement.chest - chest).toFixed(1)}cm`);
                }
                if (waist && lastMeasurement.waist && waist < lastMeasurement.waist) {
                    improvements.push(`è…°å›´å‡å°‘äº† ${(lastMeasurement.waist - waist).toFixed(1)}cm`);
                }
                if (arm && lastMeasurement.arm && arm < lastMeasurement.arm) {
                    improvements.push(`è‡‚å›´å‡å°‘äº† ${(lastMeasurement.arm - arm).toFixed(1)}cm`);
                }
                if (leg && lastMeasurement.leg && leg < lastMeasurement.leg) {
                    improvements.push(`è…¿å›´å‡å°‘äº† ${(lastMeasurement.leg - leg).toFixed(1)}cm`);
                }
            }

            // ä¿å­˜æˆ–æ›´æ–°è®°å½•
            if (existingEntry) {
                existingEntry.chest = chest || existingEntry.chest;
                existingEntry.waist = waist || existingEntry.waist;
                existingEntry.arm = arm || existingEntry.arm;
                existingEntry.leg = leg || existingEntry.leg;
            } else {
                measurements.push({
                    date: date,
                    chest: chest,
                    waist: waist,
                    arm: arm,
                    leg: leg
                });
            }

            saveMeasurements();
            updateMeasurementTable();
            updateMeasurementLineChart();
            clearMeasurementInput();

            // å¦‚æœæœ‰è¿›æ­¥ï¼Œåº†ç¥ä¸€ä¸‹
            if (improvements.length > 0) {
                createFireworks();
                const improvementMessage = improvements.join('<br>');
                showCongratulations(`${improvementMessage}<br>å¤ªæ£’äº†ï¼Œä½ çš„èº«æåœ¨å˜å¥½ï¼`);
            }
        }

        // æ¸…ç©ºå›´åº¦è®°å½•
        function clearMeasurements() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›´åº¦è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                measurements = [];
                saveMeasurements();
                updateMeasurementTable();
                updateMeasurementLineChart();
            }
        }

        // åˆ é™¤å•æ¡å›´åº¦è®°å½•
        function deleteMeasurement(date) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${date} çš„å›´åº¦è®°å½•å—ï¼Ÿ`)) {
                measurements = measurements.filter(entry => entry.date !== date);
                saveMeasurements();
                updateMeasurementTable();
                updateMeasurementLineChart();
            }
        }

        // ä¿å­˜å›´åº¦æ•°æ®
        function saveMeasurements() {
            localStorage.setItem('measurements', JSON.stringify(measurements));
        }

        // æ¸…ç©ºå›´åº¦è¾“å…¥æ¡†
        function clearMeasurementInput() {
            document.getElementById('chestValue').value = '';
            document.getElementById('waistValue').value = '';
            document.getElementById('armValue').value = '';
            document.getElementById('legValue').value = '';
        }

        // åˆ›å»ºçƒŸèŠ±æ•ˆæœ
        function createFireworks() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff6600', '#ff9900'];
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 9999;
            `;
            document.body.appendChild(container);

            // åˆ›å»ºå¤šä¸ªçƒŸèŠ±
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    const startX = Math.random() * window.innerWidth;
                    const startY = Math.random() * (window.innerHeight * 0.6);
                    const color = colors[Math.floor(Math.random() * colors.length)];

                    firework.style.cssText = `
                        position: absolute;
                        left: ${startX}px;
                        top: ${startY}px;
                        width: 10px;
                        height: 10px;
                        background: ${color};
                        border-radius: 50%;
                        box-shadow: 0 0 10px ${color}, 0 0 20px ${color}, 0 0 30px ${color};
                        animation: explode 1s ease-out forwards;
                    `;

                    container.appendChild(firework);

                    // åˆ›å»ºçˆ†ç‚¸ç²’å­
                    for (let j = 0; j < 30; j++) {
                        const particle = document.createElement('div');
                        const angle = (Math.PI * 2 * j) / 30;
                        const velocity = 50 + Math.random() * 50;
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;

                        particle.style.cssText = `
                            position: absolute;
                            left: ${startX}px;
                            top: ${startY}px;
                            width: 4px;
                            height: 4px;
                            background: ${color};
                            border-radius: 50%;
                            animation: particle 1s ease-out forwards;
                            transform: translate(${tx}px, ${ty}px);
                        `;

                        container.appendChild(particle);

                        setTimeout(() => {
                            particle.remove();
                        }, 1000);
                    }

                    setTimeout(() => {
                        firework.remove();
                    }, 1000);
                }, i * 200);
            }

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes explode {
                    0% { transform: scale(1); opacity: 1; }
                    100% { transform: scale(3); opacity: 0; }
                }
                @keyframes particle {
                    0% { transform: translate(0, 0); opacity: 1; }
                    100% { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // æ¸…ç†
            setTimeout(() => {
                container.remove();
                style.remove();
            }, 2000);
        }

        // æ˜¾ç¤ºæ­å–œæç¤º
        function showCongratulations(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-in;
            `;

            const congratsBox = document.createElement('div');
            congratsBox.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px 60px;
                border-radius: 20px;
                text-align: center;
                color: white;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                animation: slideIn 0.5s ease-out;
                max-width: 90%;
            `;

            congratsBox.innerHTML = `
                <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
                <h2 style="font-size: 2em; margin-bottom: 15px;">æ­å–œä½ ï¼</h2>
                <p style="font-size: 1.2em; margin-bottom: 25px; line-height: 1.6;">${message}</p>
                <button onclick="this.parentElement.parentElement.remove();" style="
                    background: white;
                    color: #667eea;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 25px;
                    font-size: 1.1em;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">å¤ªæ£’äº†ï¼</button>
            `;

            overlay.appendChild(congratsBox);
            document.body.appendChild(overlay);

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        overlay.remove();
                        style.remove();
                    }, 300);
                }
            }, 5000);
        }

        // å¯¼å‡ºå›´åº¦æ•°æ®
        function exportMeasurements() {
            if (measurements.length === 0) {
                alert('æš‚æ— å›´åº¦æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            try {
                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    type: 'measurements',
                    data: measurements
                };

                // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const today = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `å›´åº¦æ•°æ®_${today}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('âœ… å›´åº¦æ•°æ®å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶åï¼šå›´åº¦æ•°æ®_' + today + '.json\n\nè¯·å¦¥å–„ä¿å­˜æ­¤æ–‡ä»¶ï¼Œç”¨äºå°†æ¥æ¢å¤æ•°æ®ã€‚');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // å¯¼å…¥å›´åº¦æ•°æ®
        function importMeasurements(event) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!jsonData.data || !Array.isArray(jsonData.data)) {
                        throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }

                    // æ£€æŸ¥æ˜¯å¦æ˜¯å›´åº¦æ•°æ®
                    if (jsonData.type !== 'measurements') {
                        throw new Error('è¿™ä¸æ˜¯å›´åº¦æ•°æ®æ–‡ä»¶');
                    }

                    // åˆå¹¶æ•°æ®ï¼ˆå¦‚æœæ—¥æœŸç›¸åŒåˆ™è¦†ç›–ï¼‰
                    jsonData.data.forEach(importedEntry => {
                        const existingIndex = measurements.findIndex(entry => entry.date === importedEntry.date);
                        if (existingIndex !== -1) {
                            measurements[existingIndex] = importedEntry;
                        } else {
                            measurements.push(importedEntry);
                        }
                    });

                    // ä¿å­˜å¹¶æ›´æ–°æ˜¾ç¤º
                    saveMeasurements();
                    updateMeasurementTable();
                    updateMeasurementLineChart();

                    alert(`âœ… å›´åº¦æ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå…±å¯¼å…¥ ${jsonData.data.length} æ¡è®°å½•\n\nå·²ä¸ç°æœ‰æ•°æ®åˆå¹¶ã€‚`);
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
                
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // æ›´æ–°å›´åº¦å†å²è®°å½•è¡¨æ ¼
        function updateMeasurementTable() {
            const tbody = document.getElementById('measurementTableBody');
            tbody.innerHTML = '';

            if (measurements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            measurements.sort((a, b) => new Date(b.date) - new Date(a.date));

            measurements.forEach(entry => {
                tbody.innerHTML += `
                    <tr>
                        <td data-label="æ—¥æœŸ">${entry.date}</td>
                        <td data-label="èƒ¸å›´">${entry.chest || '--'}</td>
                        <td data-label="è…°å›´">${entry.waist || '--'}</td>
                        <td data-label="è‡‚å›´">${entry.arm || '--'}</td>
                        <td data-label="è…¿å›´">${entry.leg || '--'}</td>
                        <td data-label="æ“ä½œ">
                            <button class="delete-btn" onclick="deleteMeasurement('${entry.date}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
        }

        // æ›´æ–°å›´åº¦è¶‹åŠ¿å›¾è¡¨
        function updateMeasurementLineChart() {
            const ctx = document.getElementById('measurementLineChart').getContext('2d');

            if (measurementsLineChart) {
                measurementsLineChart.destroy();
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedMeasurements = [...measurements].sort((a, b) => new Date(a.date) - new Date(b.date));
            const dates = sortedMeasurements.map(entry => entry.date);
            const chestData = sortedMeasurements.map(entry => entry.chest);
            const waistData = sortedMeasurements.map(entry => entry.waist);
            const armData = sortedMeasurements.map(entry => entry.arm);
            const legData = sortedMeasurements.map(entry => entry.leg);

            if (dates.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®ï¼Œæ— æ³•æ˜¾ç¤ºå›¾è¡¨', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            measurementsLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'èƒ¸å›´',
                            data: chestData,
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'è…°å›´',
                            data: waistData,
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'è‡‚å›´',
                            data: armData,
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'è…¿å›´',
                            data: legData,
                            borderColor: 'rgba(155, 89, 182, 1)',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                    if (value === null || value === undefined) {
                                        return `${label}: æ— æ•°æ®`;
                                    }
                                    return `${label}: ${value}cm`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'å›´åº¦ (cm)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        // æ·»åŠ é¥®é£Ÿè®°å½•
        function addDiet() {
            const date = document.getElementById('dietDate').value;
            const mode = document.getElementById('dietInputMode').value;

            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            let foods = [];

            if (mode === 'smart') {
                // ä½¿ç”¨AIè§£æçš„ç»“æœ
                if (!parsedNutrition) {
                    alert('è¯·å…ˆç‚¹å‡»"AI è§£æé£Ÿç‰©"æŒ‰é’®');
                    return;
                }
                foods = parsedNutrition;
            } else {
                // æ‰‹åŠ¨è¾“å…¥
                const protein = parseFloat(document.getElementById('protein').value) || 0;
                const fat = parseFloat(document.getElementById('fat').value) || 0;
                const carbs = parseFloat(document.getElementById('carbs').value) || 0;
                const calories = (protein * 4) + (fat * 9) + (carbs * 4);
                foods = [{
                    name: 'æ‰‹åŠ¨è¾“å…¥',
                    description: `æ‰‹åŠ¨è¾“å…¥ï¼šè›‹ç™½è´¨${protein}gï¼Œè„‚è‚ª${fat}gï¼Œç¢³æ°´${carbs}g`,
                    protein,
                    fat,
                    carbs,
                    calories
                }];
            }

            if (foods.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€é¡¹è¥å…»æ•°æ®');
                return;
            }

            // è®¡ç®—æ€»è¥å…»
            const totalProtein = foods.reduce((sum, food) => sum + (food.protein || 0), 0);
            const totalFat = foods.reduce((sum, food) => sum + (food.fat || 0), 0);
            const totalCarbs = foods.reduce((sum, food) => sum + (food.carbs || 0), 0);
            const totalCalories = foods.reduce((sum, food) => sum + (food.calories || 0), 0);

            const existingEntry = healthData.find(entry => entry.date === date);
            if (existingEntry) {
                if (!existingEntry.diet) {
                    existingEntry.diet = { protein: 0, fat: 0, carbs: 0, calories: 0, foodItems: [] };
                }
                existingEntry.diet.protein += totalProtein;
                existingEntry.diet.fat += totalFat;
                existingEntry.diet.carbs += totalCarbs;
                existingEntry.diet.calories += totalCalories;
                foods.forEach(food => {
                    existingEntry.diet.foodItems.push({
                        description: food.name || food.description,
                        protein: food.protein || 0,
                        fat: food.fat || 0,
                        carbs: food.carbs || 0,
                        calories: food.calories || 0
                    });
                });
            } else {
                healthData.push({
                    date: date,
                    weight: null,
                    diet: { 
                        protein: totalProtein, 
                        fat: totalFat, 
                        carbs: totalCarbs, 
                        calories: totalCalories, 
                        foodItems: foods.map(food => ({ 
                            description: food.name || food.description, 
                            protein: food.protein || 0, 
                            fat: food.fat || 0, 
                            carbs: food.carbs || 0, 
                            calories: food.calories || 0 
                        })) 
                    },
                    exercise: null
                });
            }

            saveData();
            updateUI();

            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸä¿¡æ¯
            let message = 'âœ… é¥®é£Ÿæ·»åŠ æˆåŠŸï¼\n\n';
            foods.forEach(food => {
                message += `â€¢ ${food.name || food.description}\n`;
                message += `  è›‹ç™½è´¨ï¼š${food.protein}gï¼Œè„‚è‚ªï¼š${food.fat}gï¼Œç¢³æ°´ï¼š${food.carbs}gï¼Œå¡è·¯é‡Œï¼š${food.calories}kcal\n`;
            });
            message += `\næ€»è®¡ï¼šè›‹ç™½è´¨ ${totalProtein}gï¼Œè„‚è‚ª ${totalFat}gï¼Œç¢³æ°´ ${totalCarbs}gï¼Œå¡è·¯é‡Œ ${totalCalories}kcal`;
            alert(message);

            clearDietInput();
        }

        // æ·»åŠ è¿åŠ¨è®°å½•
        function addExercise() {
            const date = document.getElementById('exerciseDate').value;
            const mode = document.getElementById('exerciseInputMode').value;

            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            let exercises = [];

            if (mode === 'smart') {
                // ä½¿ç”¨AIè®¡ç®—çš„ç»“æœ
                if (!parsedExerciseCalories) {
                    alert('è¯·å…ˆç‚¹å‡»"AI è®¡ç®—å¡è·¯é‡Œ"æŒ‰é’®');
                    return;
                }
                exercises = parsedExerciseCalories;
            } else {
                // æ‰‹åŠ¨è¾“å…¥
                const calories = parseFloat(document.getElementById('exerciseCalories').value) || 0;
                exercises = [{
                    description: `æ‰‹åŠ¨è¾“å…¥ï¼š${calories}kcal`,
                    calories
                }];
            }

            if (exercises.length === 0) {
                alert('è¯·è¾“å…¥æˆ–è®¡ç®—è¿åŠ¨æ¶ˆè€—å¡è·¯é‡Œ');
                return;
            }

            // è®¡ç®—æ€»å¡è·¯é‡Œ
            const totalCalories = exercises.reduce((sum, exercise) => sum + (exercise.calories || 0), 0);

            const existingEntry = healthData.find(entry => entry.date === date);
            if (existingEntry) {
                if (!existingEntry.exercise) {
                    existingEntry.exercise = { calories: 0, exerciseItems: [] };
                }
                existingEntry.exercise.calories += totalCalories;
                exercises.forEach(exercise => {
                    existingEntry.exercise.exerciseItems.push({
                        description: exercise.description,
                        calories: exercise.calories || 0
                    });
                });
            } else {
                healthData.push({
                    date: date,
                    weight: null,
                    diet: null,
                    exercise: { 
                        calories: totalCalories, 
                        exerciseItems: exercises.map(exercise => ({ 
                            description: exercise.description, 
                            calories: exercise.calories || 0 
                        })) 
                    }
                });
            }

            saveData();
            updateUI();

            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸä¿¡æ¯
            let message = 'âœ… è¿åŠ¨æ·»åŠ æˆåŠŸï¼\n\n';
            exercises.forEach(exercise => {
                message += `â€¢ ${exercise.description}\n`;
                message += `  æ¶ˆè€—å¡è·¯é‡Œï¼š${exercise.calories}kcal\n`;
            });
            message += `\næ€»è®¡æ¶ˆè€—ï¼š${totalCalories}kcal`;
            alert(message);

            clearExerciseInput();
        }

        // åˆ é™¤è®°å½•
        function deleteEntry(date) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                healthData = healthData.filter(entry => entry.date !== date);
                saveData();
                updateUI();
            }
        }

        // åˆ é™¤å•ä¸ªé£Ÿç‰©é¡¹
        function deleteFoodItem(date, index) {
            const entry = healthData.find(e => e.date === date);
            if (entry && entry.diet && entry.diet.foodItems && entry.diet.foodItems[index]) {
                const item = entry.diet.foodItems[index];
                if (confirm(`ç¡®å®šè¦åˆ é™¤é£Ÿç‰©"${item.description}"å—ï¼Ÿ`)) {
                    // ä»foodItemsä¸­ç§»é™¤è¯¥é¡¹
                    entry.diet.foodItems.splice(index, 1);

                    // é‡æ–°è®¡ç®—æ€»æ•°
                    if (entry.diet.foodItems.length === 0) {
                        // å¦‚æœæ²¡æœ‰é£Ÿç‰©é¡¹äº†ï¼Œå°†dietè®¾ä¸ºnull
                        entry.diet = null;
                    } else {
                        // é‡æ–°è®¡ç®—æ€»å’Œ
                        entry.diet.protein = entry.diet.foodItems.reduce((sum, item) => sum + (item.protein || 0), 0);
                        entry.diet.fat = entry.diet.foodItems.reduce((sum, item) => sum + (item.fat || 0), 0);
                        entry.diet.carbs = entry.diet.foodItems.reduce((sum, item) => sum + (item.carbs || 0), 0);
                        entry.diet.calories = entry.diet.foodItems.reduce((sum, item) => sum + (item.calories || 0), 0);
                    }

                    saveData();
                    updateUI();
                }
            }
        }

        // åˆ é™¤å•ä¸ªè¿åŠ¨é¡¹
        function deleteExerciseItem(date, index) {
            const entry = healthData.find(e => e.date === date);
            if (entry && entry.exercise && entry.exercise.exerciseItems && entry.exercise.exerciseItems[index]) {
                const item = entry.exercise.exerciseItems[index];
                if (confirm(`ç¡®å®šè¦åˆ é™¤è¿åŠ¨"${item.description}"å—ï¼Ÿ`)) {
                    // ä»exerciseItemsä¸­ç§»é™¤è¯¥é¡¹
                    entry.exercise.exerciseItems.splice(index, 1);

                    // é‡æ–°è®¡ç®—æ€»æ•°
                    if (entry.exercise.exerciseItems.length === 0) {
                        // å¦‚æœæ²¡æœ‰è¿åŠ¨é¡¹äº†ï¼Œå°†exerciseè®¾ä¸ºnull
                        entry.exercise = null;
                    } else {
                        // é‡æ–°è®¡ç®—æ€»å’Œ
                        entry.exercise.calories = entry.exercise.exerciseItems.reduce((sum, item) => sum + (item.calories || 0), 0);
                    }

                    saveData();
                    updateUI();
                }
            }
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('healthData', JSON.stringify(healthData));
        }

        // æ¸…ç©ºè¾“å…¥æ¡†
        function clearWeightInput() {
            document.getElementById('weightValue').value = '';
            // ä¿ç•™èº«é«˜ã€å¹´é¾„ã€æ€§åˆ«ä½œä¸ºé»˜è®¤å€¼ï¼Œä¸æ¸…ç©º
            document.getElementById('bmiResult').style.display = 'none';
        }
        function clearDietInput() {
            document.getElementById('protein').value = '';
            document.getElementById('fat').value = '';
            document.getElementById('carbs').value = '';
            document.getElementById('foodDescription').value = '';
            parsedNutrition = null;
            document.getElementById('foodAnalysisResult').style.display = 'none';
        }

        function clearExerciseInput() {
            document.getElementById('exerciseCalories').value = '';
            document.getElementById('exerciseDescription').value = '';
            parsedExerciseCalories = null;
            document.getElementById('exerciseCaloriesResult').style.display = 'none';
        }

        // æ›´æ–°UI
        function updateUI() {
            // æŒ‰æ—¥æœŸæ’åº
            healthData.sort((a, b) => new Date(a.date) - new Date(b.date));

            // æ›´æ–°å†å²è®°å½•è¡¨æ ¼
            updateHistoryTable();

            // æ›´æ–°å›¾è¡¨
            updateNutritionPieChartForDate();
            updateCaloriesLineChart();
            updateWeightLineChart();
            updateWeightBalanceChart();

            // æ›´æ–°å½“å‰BMIæ˜¾ç¤º
            updateCurrentBMI();
        }

        // æ›´æ–°å†å²è®°å½•è¡¨æ ¼
        function updateHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (healthData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            healthData.forEach(entry => {
                const balance = (entry.diet?.calories || 0) - (entry.exercise?.calories || 0);
                const balanceClass = balance > 0 ? 'surplus' : 'deficit';
                const balanceText = balance > 0 ? `+${balance}` : balance;

                // ç”Ÿæˆé£Ÿç‰©è¯¦æƒ…HTML
                let foodDetailsHTML = '--';
                if (entry.diet?.foodItems && entry.diet.foodItems.length > 0) {
                    foodDetailsHTML = entry.diet.foodItems.map((item, index) => {
                        const deleteBtn = showDeleteButtons ?
                            `<button class="delete-btn" style="padding: 4px 10px; font-size: 0.75em; margin-left: 8px;" onclick="deleteFoodItem('${entry.date}', ${index})">åˆ é™¤</button>` : '';
                        return `<div style="font-size: 0.85em; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span>ğŸ½ï¸ ${item.description} <span style="color: #e67e22;">(${item.calories}kcal)</span></span>
                            ${deleteBtn}
                        </div>`;
                    }).join('');
                }

                // ç”Ÿæˆè¿åŠ¨è¯¦æƒ…HTML
                let exerciseDetailsHTML = '--';
                if (entry.exercise?.exerciseItems && entry.exercise.exerciseItems.length > 0) {
                    exerciseDetailsHTML = entry.exercise.exerciseItems.map((item, index) => {
                        const deleteBtn = showDeleteButtons ?
                            `<button class="delete-btn" style="padding: 4px 10px; font-size: 0.75em; margin-left: 8px;" onclick="deleteExerciseItem('${entry.date}', ${index})">åˆ é™¤</button>` : '';
                        return `<div style="font-size: 0.85em; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span>ğŸ’ª ${item.description} <span style="color: #27ae60;">(${item.calories}kcal)</span></span>
                            ${deleteBtn}
                        </div>`;
                    }).join('');
                }

                const toggleBtnText = showDeleteButtons ? 'éšè—åˆ é™¤' : 'åˆ é™¤å•ä¸ª';
                const toggleBtnStyle = showDeleteButtons ? 'background: #95a5a6;' : '';

                tbody.innerHTML += `
                    <tr>
                        <td data-label="æ—¥æœŸ">${entry.date}</td>
                        <td data-label="ä½“é‡">${entry.weight || '--'}</td>
                        <td data-label="é£Ÿç‰©è¯¦æƒ…" style="max-width: 300px;">${foodDetailsHTML}</td>
                        <td data-label="è¿åŠ¨è¯¦æƒ…" style="max-width: 300px;">${exerciseDetailsHTML}</td>
                        <td data-label="æ€»æ‘„å…¥">${entry.diet?.calories || '--'}</td>
                        <td data-label="æ€»æ¶ˆè€—">${entry.exercise?.calories || '--'}</td>
                        <td data-label="å¡è·¯é‡Œå¹³è¡¡" class="${balanceClass}">${balanceText}</td>
                        <td data-label="æ“ä½œ" style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="delete-btn" onclick="deleteEntry('${entry.date}')">åˆ é™¤å…¨å¤©</button>
                            <button class="delete-btn" onclick="toggleShowDeleteButtons()" style="${toggleBtnStyle}">${toggleBtnText}</button>
                        </td>
                    </tr>
                `;
            });
        }

        // æ ¹æ®é€‰æ‹©çš„æ—¥æœŸæ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStatsForDate(date) {
            const entry = healthData.find(e => e.date === date);
            
            // æ›´æ–°æ ‡ç­¾æ–‡æœ¬
            const today = new Date().toISOString().split('T')[0];
            const dateLabel = date === today ? 'ä»Šæ—¥' : date;
            document.getElementById('intakeLabel').textContent = `${dateLabel}æ‘„å…¥å¡è·¯é‡Œ`;
            document.getElementById('burnedLabel').textContent = `${dateLabel}æ¶ˆè€—å¡è·¯é‡Œ`;
            document.getElementById('balanceLabel').textContent = `${dateLabel}å¡è·¯é‡Œ`;
            document.getElementById('weightLabel').textContent = `${dateLabel}ä½“é‡`;

            // æ›´æ–°æ•°å€¼
            const intake = entry?.diet?.calories || 0;
            const burned = entry?.exercise?.calories || 0;
            const balance = intake - burned;
            const weight = entry?.weight || null;

            document.getElementById('todayIntake').textContent = intake;
            document.getElementById('todayBurned').textContent = burned;
            document.getElementById('todayBalance').textContent = (balance > 0 ? '+' : '') + balance;
            document.getElementById('todayBalance').style.color = balance > 0 ? '#e74c3c' : '#27ae60';
            
            if (weight !== null) {
                document.getElementById('currentWeight').textContent = weight;
            } else {
                // å¦‚æœå½“å¤©æ²¡æœ‰ä½“é‡è®°å½•ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„ä½“é‡è®°å½•
                const weightEntries = healthData.filter(e => e.weight !== null);
                if (weightEntries.length > 0) {
                    document.getElementById('currentWeight').textContent = weightEntries[weightEntries.length - 1].weight;
                } else {
                    document.getElementById('currentWeight').textContent = '--';
                }
            }
        }

        // æ›´æ–°è¥å…»é¥¼çŠ¶å›¾ï¼ˆæ ¹æ®é€‰æ‹©çš„æ—¥æœŸï¼‰
        function updateNutritionPieChartForDate() {
            const selectedDate = document.getElementById('nutritionDate').value;
            const entry = healthData.find(e => e.date === selectedDate);
            const ctx = document.getElementById('nutritionPieChart').getContext('2d');

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºé€‰ä¸­æ—¥æœŸçš„æ•°æ®
            updateStatsForDate(selectedDate);

            if (nutritionPieChart) {
                nutritionPieChart.destroy();
            }

            const protein = entry?.diet?.protein || 0;
            const fat = entry?.diet?.fat || 0;
            const carbs = entry?.diet?.carbs || 0;
            const total = protein + fat + carbs;

            if (total === 0) {
                // æ˜¾ç¤ºç©ºæ•°æ®æç¤º
                nutritionPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['è›‹ç™½è´¨', 'è„‚è‚ª', 'ç¢³æ°´åŒ–åˆç‰©'],
                        datasets: [{
                            data: [1, 1, 1],
                            backgroundColor: ['rgba(102, 126, 234, 0.2)', 'rgba(231, 76, 60, 0.2)', 'rgba(46, 204, 113, 0.2)'],
                            borderColor: ['rgba(102, 126, 234, 0.5)', 'rgba(231, 76, 60, 0.5)', 'rgba(46, 204, 113, 0.5)'],
                            borderWidth: 2,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '50%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#667eea',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value}g (${percentage}%)`;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `${selectedDate} - æš‚æ— æ•°æ®`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: '#667eea',
                                padding: 20
                            }
                        }
                    }
                });
                return;
            }

            // è®¡ç®—ç™¾åˆ†æ¯”
            const proteinPercent = ((protein / total) * 100).toFixed(1);
            const fatPercent = ((fat / total) * 100).toFixed(1);
            const carbsPercent = ((carbs / total) * 100).toFixed(1);

            // åˆ›å»ºç²¾è‡´çš„æ¸å˜è‰²
            const proteinGradient = ctx.createLinearGradient(0, 0, 0, 400);
            proteinGradient.addColorStop(0, 'rgba(102, 126, 234, 0.9)');
            proteinGradient.addColorStop(1, 'rgba(102, 126, 234, 0.7)');

            const fatGradient = ctx.createLinearGradient(0, 0, 0, 400);
            fatGradient.addColorStop(0, 'rgba(231, 76, 60, 0.9)');
            fatGradient.addColorStop(1, 'rgba(231, 76, 60, 0.7)');

            const carbsGradient = ctx.createLinearGradient(0, 0, 0, 400);
            carbsGradient.addColorStop(0, 'rgba(46, 204, 113, 0.9)');
            carbsGradient.addColorStop(1, 'rgba(46, 204, 113, 0.7)');

            nutritionPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['è›‹ç™½è´¨', 'è„‚è‚ª', 'ç¢³æ°´åŒ–åˆç‰©'],
                    datasets: [{
                        data: [protein, fat, carbs],
                        backgroundColor: [
                            proteinGradient,
                            fatGradient,
                            carbsGradient
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(46, 204, 113, 1)'
                        ],
                        borderWidth: 3,
                        hoverOffset: 10,
                        hoverBorderColor: '#fff',
                        hoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 12,
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 10,
                                boxHeight: 10,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${value}g (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            padding: 14,
                            cornerRadius: 10,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    const calories = (context.dataIndex === 0 ? value * 4 : context.dataIndex === 1 ? value * 9 : value * 4).toFixed(0);
                                    return `${label}: ${value}g (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    const value = context.parsed || 0;
                                    const calories = (context.dataIndex === 0 ? value * 4 : context.dataIndex === 1 ? value * 9 : value * 4).toFixed(0);
                                    return `å¡è·¯é‡Œ: ${calories}kcal`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `${selectedDate} - è¥å…»æ„æˆ`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#667eea',
                            padding: {
                                top: 5,
                                bottom: 15
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'customSubtitle',
                    afterDraw: function(chart) {
                        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const calories = entry?.diet?.calories || 0;
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.font = 'bold 12px Arial';
                        ctx.fillStyle = '#666';
                        ctx.textAlign = 'center';
                        ctx.fillText(`æ€»è´¨é‡: ${total}g | æ€»å¡è·¯é‡Œ: ${calories}kcal`, chart.chartArea.left + chart.chartArea.width / 2, chart.chartArea.top - 5);
                        ctx.restore();
                    }
                }]
            });
        }

        // AI åˆ†æé¥®é£Ÿç»“æ„
        async function analyzeNutritionStructure() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';
            
            const selectedDate = document.getElementById('nutritionDate').value;
            const entry = healthData.find(e => e.date === selectedDate);

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const protein = entry?.diet?.protein || 0;
            const fat = entry?.diet?.fat || 0;
            const carbs = entry?.diet?.carbs || 0;
            const totalCalories = entry?.diet?.calories || 0;

            if (totalCalories === 0) {
                document.getElementById('nutritionAnalysis').innerHTML = `<p style="color: #999; font-style: italic;">${selectedDate}æš‚æ— é¥®é£Ÿæ•°æ®ï¼Œè¯·å…ˆæ·»åŠ è¯¥æ—¥æœŸçš„é¥®é£Ÿè®°å½•ã€‚</p>`;
                return;
            }

            const analysisDiv = document.getElementById('nutritionAnalysis');
            analysisDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨åˆ†æé¥®é£Ÿç»“æ„...</p>';

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¥å…»å­¦ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„é¥®é£Ÿç»“æ„æ˜¯å¦åˆç†ï¼Œå¹¶ç»™å‡ºå…·ä½“çš„æ”¹è¿›å»ºè®®ã€‚å¥åº·é¥®é£Ÿå»ºè®®ï¼šè›‹ç™½è´¨å 20-30%ï¼Œè„‚è‚ªå 20-30%ï¼Œç¢³æ°´åŒ–åˆç‰©å 40-60%ã€‚è¯·ç”¨å‹å¥½ã€é¼“åŠ±çš„è¯­æ°”ï¼Œç»™å‡ºå®ç”¨çš„å»ºè®®ã€‚'
                            },
                            {
                                role: 'user',
                                content: `è¯·åˆ†æä»¥ä¸‹${selectedDate}çš„é¥®é£Ÿç»“æ„æ˜¯å¦åˆç†ï¼Œå¹¶ç»™å‡ºæ”¹è¿›å»ºè®®ï¼š\n\næ‘„å…¥ï¼š\nâ€¢ è›‹ç™½è´¨ï¼š${protein}g\nâ€¢ è„‚è‚ªï¼š${fat}g\nâ€¢ ç¢³æ°´åŒ–åˆç‰©ï¼š${carbs}g\nâ€¢ æ€»å¡è·¯é‡Œï¼š${totalCalories}kcal\n\nè¯·ç»™å‡ºè¯¦ç»†çš„åˆ†æå’Œå»ºè®®ï¼ŒåŒ…æ‹¬ï¼š\n1. å½“å‰è¥å…»ç´ æ¯”ä¾‹æ˜¯å¦åˆç†\n2. å„é¡¹è¥å…»ç´ çš„å æ¯”\n3. å…·ä½“çš„æ”¹è¿›å»ºè®®\n4. å¦‚æœåˆç†ï¼Œè¯·ç»™äºˆé¼“åŠ±\n\nè¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€ï¼Œåˆ†ç‚¹åˆ—å‡ºã€‚`
                            }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const analysis = data.choices[0].message.content;
                
                // æ ¼å¼åŒ–æ˜¾ç¤ºåˆ†æç»“æœ
                const formattedAnalysis = analysis
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢/g, 'ğŸ“Œ')
                    .replace(/1\./g, 'âœ…')
                    .replace(/2\./g, 'âœ…')
                    .replace(/3\./g, 'âœ…')
                    .replace(/4\./g, 'âœ…');

                analysisDiv.innerHTML = `
                    <div style="font-size: 0.95em; line-height: 1.6;">
                        ${formattedAnalysis}
                    </div>
                `;

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                analysisDiv.innerHTML = `<p style="color: #e74c3c;">âŒ åˆ†æå¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // æ›´æ–°å¡è·¯é‡ŒæŠ˜çº¿å›¾
        function updateCaloriesLineChart() {
            const ctx = document.getElementById('caloriesLineChart').getContext('2d');

            if (caloriesLineChart) {
                caloriesLineChart.destroy();
            }

            const dates = healthData.map(entry => entry.date);
            const intakeData = healthData.map(entry => entry.diet?.calories || 0);
            const burnedData = healthData.map(entry => entry.exercise?.calories || 0);
            
            // è®¡ç®—åŸºç¡€ä»£è°¢ç‡ï¼ˆBMRï¼‰- ä½¿ç”¨ä½“é‡Ã—24ä½œä¸ºä¼°ç®—å€¼
            let weight = 70; // é»˜è®¤ä½“é‡
            // è·å–æœ€æ–°çš„ä½“é‡è®°å½•
            const weightEntries = healthData.filter(entry => entry.weight !== null);
            if (weightEntries.length > 0) {
                weight = weightEntries[weightEntries.length - 1].weight;
            }
            
            // ä¸ºæ¯å¤©è®¡ç®—åŸºç¡€ä»£è°¢ï¼ˆå¦‚æœå½“å¤©æœ‰ä½“é‡è®°å½•ï¼Œä½¿ç”¨å½“å¤©çš„ä½“é‡ï¼‰
            const bmrData = healthData.map(entry => {
                const dayWeight = entry.weight || weight;
                return Math.round(dayWeight * 24); // åŸºç¡€ä»£è°¢çº¦ç­‰äºä½“é‡Ã—24
            });
            
            // è®¡ç®—å®é™…æ¶ˆè€— = åŸºç¡€ä»£è°¢ + è¿åŠ¨æ¶ˆè€—
            const actualBurnedData = bmrData.map((bmr, index) => bmr + burnedData[index]);
            
            // è®¡ç®—å‰©ä½™èƒ½é‡ = æ‘„å…¥ - å®é™…æ¶ˆè€—
            const surplusData = intakeData.map((intake, index) => intake - actualBurnedData[index]);

            caloriesLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ğŸ½ï¸ é¥®é£Ÿæ‘„å…¥',
                            data: intakeData,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'ğŸ’ª è¿åŠ¨æ¶ˆè€—',
                            data: burnedData,
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'âš–ï¸ å‡€å€¼ï¼ˆæ‘„å…¥-è¿åŠ¨ï¼‰',
                            data: intakeData.map((intake, index) => intake - burnedData[index]),
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5],
                            borderWidth: 2
                        },
                        {
                            label: 'ğŸ”¥ å®é™…æ¶ˆè€—ï¼ˆåŸºç¡€ä»£è°¢+è¿åŠ¨ï¼‰',
                            data: actualBurnedData,
                            borderColor: 'rgba(155, 89, 182, 1)',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'ğŸ“Š å‰©ä½™èƒ½é‡ï¼ˆæ‘„å…¥-å®é™…æ¶ˆè€—ï¼‰',
                            data: surplusData,
                            borderColor: 'rgba(241, 196, 15, 1)',
                            backgroundColor: 'rgba(241, 196, 15, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderDash: [10, 5],
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 15,
                                padding: 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null || value === undefined) {
                                        return `${label}: æ— æ•°æ®`;
                                    }
                                    return `${label}: ${value} kcal`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'å¡è·¯é‡Œ (kcal)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // æ›´æ–°ä½“é‡æŠ˜çº¿å›¾
        function updateWeightLineChart() {
            const ctx = document.getElementById('weightLineChart').getContext('2d');

            if (weightLineChart) {
                weightLineChart.destroy();
            }

            const weightEntries = healthData.filter(entry => entry.weight !== null);
            const dates = weightEntries.map(entry => entry.date);
            const weightData = weightEntries.map(entry => entry.weight);

            weightLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'ä½“é‡',
                        data: weightData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                    if (value === null || value === undefined) {
                                        return `${label}: æ— æ•°æ®`;
                                    }
                                    return `${label}: ${value}kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°ä½“é‡ä¸èƒ½é‡å¹³è¡¡å…³ç³»å›¾è¡¨
        function updateWeightBalanceChart() {
            const ctx = document.getElementById('weightBalanceChart').getContext('2d');

            if (weightBalanceChart) {
                weightBalanceChart.destroy();
            }

            // è·å–æ‰€æœ‰æœ‰è®°å½•çš„æ—¥æœŸ
            const allEntries = healthData.filter(entry => entry.diet || entry.exercise || entry.weight);
            
            if (allEntries.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®ï¼Œæ— æ³•æ˜¾ç¤ºå›¾è¡¨', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            // å‡†å¤‡æ•°æ®
            const dates = allEntries.map(entry => entry.date);
            const weightData = allEntries.map(entry => entry.weight || null);
            
            // è®¡ç®—å‰©ä½™èƒ½é‡ï¼ˆæ‘„å…¥ - å®é™…æ¶ˆè€—ï¼‰
            let lastWeight = 70; // é»˜è®¤ä½“é‡
            const weightEntries = healthData.filter(entry => entry.weight !== null);
            if (weightEntries.length > 0) {
                lastWeight = weightEntries[weightEntries.length - 1].weight;
            }

            const surplusData = allEntries.map(entry => {
                const dayWeight = entry.weight || lastWeight;
                const intake = entry.diet?.calories || 0;
                const burned = entry.exercise?.calories || 0;
                const bmr = dayWeight * 24;
                const actualBurned = bmr + burned;
                return Math.round(intake - actualBurned);
            });

            weightBalanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ä½“é‡ (kg)',
                            data: weightData,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            yAxisID: 'y',
                            spanGaps: true // è¿ç»­çº¿æ¡ï¼Œè·³è¿‡nullå€¼
                        },
                        {
                            label: 'å‰©ä½™èƒ½é‡ (kcal)',
                            data: surplusData,
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                    const unit = context.dataset.yAxisID === 'y' ? 'kg' : 'kcal';
                                    if (value === null || value === undefined) {
                                        return `${label}: æ— æ•°æ®`;
                                    }
                                    return `${label}: ${value}${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)'
                            },
                            beginAtZero: false
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å‰©ä½™èƒ½é‡ (kcal)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            beginAtZero: false
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        // AI åˆ†æè¿åŠ¨è¶‹åŠ¿
        async function analyzeExerciseTrend() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const exerciseEntries = healthData.filter(entry => entry.exercise && entry.exercise.calories > 0);

            if (exerciseEntries.length === 0) {
                document.getElementById('exerciseTrendAnalysis').innerHTML = '<p style="color: #999; font-style: italic;">æš‚æ— è¿åŠ¨æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ è¿åŠ¨è®°å½•ã€‚</p>';
                return;
            }

            const analysisDiv = document.getElementById('exerciseTrendAnalysis');
            analysisDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨åˆ†æè¿åŠ¨è¶‹åŠ¿...</p>';

            // å‡†å¤‡è¿åŠ¨æ•°æ®
            const exerciseData = exerciseEntries.map(entry => ({
                date: entry.date,
                calories: entry.exercise.calories,
                exercises: entry.exercise.exerciseItems || []
            }));

            const totalBurned = exerciseData.reduce((sum, item) => sum + item.calories, 0);
            const avgBurned = Math.round(totalBurned / exerciseData.length);
            const maxBurned = Math.max(...exerciseData.map(item => item.calories));

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥èº«å’Œè¿åŠ¨åˆ†æä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„è¿åŠ¨è¶‹åŠ¿ï¼Œç»™å‡ºä¸“ä¸šçš„å»ºè®®å’Œè¯„ä»·ã€‚ç”¨å‹å¥½ã€é¼“åŠ±çš„è¯­æ°”ã€‚'
                            },
                            {
                                role: 'user',
                                content: `è¯·åˆ†æä»¥ä¸‹è¿åŠ¨è¶‹åŠ¿æ•°æ®ï¼š\n\nè¿åŠ¨è®°å½•å¤©æ•°ï¼š${exerciseData.length}å¤©\næ€»æ¶ˆè€—å¡è·¯é‡Œï¼š${totalBurned}kcal\nå¹³å‡æ¯æ—¥æ¶ˆè€—ï¼š${avgBurned}kcal\nå•æ—¥æœ€é«˜æ¶ˆè€—ï¼š${maxBurned}kcal\n\nè¯¦ç»†æ•°æ®ï¼š\n${exerciseData.map(item => `â€¢ ${item.date}ï¼š${item.calories}kcal${item.exercises.length > 0 ? 'ï¼ˆ' + item.exercises.map(e => e.description).join('ã€') + 'ï¼‰' : ''}`).join('\n')}\n\nè¯·ç»™å‡ºè¯¦ç»†çš„åˆ†æï¼ŒåŒ…æ‹¬ï¼š\n1. è¿åŠ¨å¼ºåº¦è¯„ä¼°\n2. è¿åŠ¨é¢‘ç‡åˆ†æ\n3. è¿åŠ¨æ•ˆæœè¯„ä»·\n4. å…·ä½“çš„æ”¹è¿›å»ºè®®\n5. é¼“åŠ±æ€§çš„è¯„ä»·\n\nè¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€ï¼Œåˆ†ç‚¹åˆ—å‡ºã€‚`
                            }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const analysis = data.choices[0].message.content;

                // æ ¼å¼åŒ–æ˜¾ç¤ºåˆ†æç»“æœ
                const formattedAnalysis = analysis
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢/g, 'ğŸ“Œ')
                    .replace(/1\./g, 'âœ…')
                    .replace(/2\./g, 'âœ…')
                    .replace(/3\./g, 'âœ…')
                    .replace(/4\./g, 'âœ…')
                    .replace(/5\./g, 'âœ…');

                analysisDiv.innerHTML = `
                    <div style="font-size: 0.95em; line-height: 1.6;">
                        ${formattedAnalysis}
                    </div>
                `;

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                analysisDiv.innerHTML = `<p style="color: #e74c3c;">âŒ åˆ†æå¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // AI åˆ†æä½“é‡è¶‹åŠ¿
        async function analyzeWeightTrend() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const weightEntries = healthData.filter(entry => entry.weight !== null);

            if (weightEntries.length < 2) {
                document.getElementById('weightTrendAnalysis').innerHTML = '<p style="color: #999; font-style: italic;">ä½“é‡è®°å½•ä¸è¶³2å¤©ï¼Œæ— æ³•è¿›è¡Œè¶‹åŠ¿åˆ†æã€‚è¯·è‡³å°‘æ·»åŠ 2å¤©çš„ä½“é‡è®°å½•ã€‚</p>';
                return;
            }

            const analysisDiv = document.getElementById('weightTrendAnalysis');
            analysisDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨åˆ†æä½“é‡è¶‹åŠ¿...</p>';

            // å‡†å¤‡ä½“é‡æ•°æ®
            const weights = weightEntries.map(entry => entry.weight);
            const firstWeight = weights[0];
            const lastWeight = weights[weights.length - 1];
            const weightChange = lastWeight - firstWeight;
            const daysDiff = Math.floor((new Date(weightEntries[weightEntries.length - 1].date) - new Date(weightEntries[0].date)) / (1000 * 60 * 60 * 24));
            const avgWeeklyChange = daysDiff > 0 ? ((weightChange / daysDiff) * 7).toFixed(2) : 0;

            try {
                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·ç®¡ç†å’Œä½“é‡æ§åˆ¶ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„ä½“é‡è¶‹åŠ¿ï¼Œç»™å‡ºä¸“ä¸šçš„å»ºè®®å’Œè¯„ä»·ã€‚ç”¨å‹å¥½ã€é¼“åŠ±çš„è¯­æ°”ã€‚'
                            },
                            {
                                role: 'user',
                                content: `è¯·åˆ†æä»¥ä¸‹ä½“é‡è¶‹åŠ¿æ•°æ®ï¼š\n\nè®°å½•å¤©æ•°ï¼š${weightEntries.length}å¤©\nåˆå§‹ä½“é‡ï¼š${firstWeight}kg\nå½“å‰ä½“é‡ï¼š${lastWeight}kg\nä½“é‡å˜åŒ–ï¼š${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)}kg\næ—¶é—´è·¨åº¦ï¼š${daysDiff}å¤©\nå¹³å‡æ¯å‘¨å˜åŒ–ï¼š${avgWeeklyChange > 0 ? '+' : ''}${avgWeeklyChange}kg/å‘¨\n\nè¯¦ç»†æ•°æ®ï¼š\n${weightEntries.map(entry => `â€¢ ${entry.date}ï¼š${entry.weight}kg`).join('\n')}\n\nè¯·ç»™å‡ºè¯¦ç»†çš„åˆ†æï¼ŒåŒ…æ‹¬ï¼š\n1. ä½“é‡è¶‹åŠ¿è¯„ä¼°ï¼ˆå¢é‡/å‡é‡/ç¨³å®šï¼‰\n2. å˜åŒ–é€Ÿåº¦åˆ†æ\n3. å¥åº·ç¨‹åº¦è¯„ä»·\n4. ç›®æ ‡è¾¾æˆå»ºè®®\n5. å…·ä½“çš„æ”¹è¿›å»ºè®®\n6. é¼“åŠ±æ€§çš„è¯„ä»·\n\nè¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€ï¼Œåˆ†ç‚¹åˆ—å‡ºã€‚`
                            }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const analysis = data.choices[0].message.content;

                // æ ¼å¼åŒ–æ˜¾ç¤ºåˆ†æç»“æœ
                const formattedAnalysis = analysis
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢/g, 'ğŸ“Œ')
                    .replace(/1\./g, 'âœ…')
                    .replace(/2\./g, 'âœ…')
                    .replace(/3\./g, 'âœ…')
                    .replace(/4\./g, 'âœ…')
                    .replace(/5\./g, 'âœ…')
                    .replace(/6\./g, 'âœ…');

                analysisDiv.innerHTML = `
                    <div style="font-size: 0.95em; line-height: 1.6;">
                        ${formattedAnalysis}
                    </div>
                `;

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                analysisDiv.innerHTML = `<p style="color: #e74c3c;">âŒ åˆ†æå¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // AI åˆ†ææ•´ä½“æ•°æ®
        async function analyzeOverallData() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            if (healthData.length === 0) {
                document.getElementById('overallAnalysis').innerHTML = '<p style="color: #999; font-style: italic;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ å¥åº·è®°å½•ã€‚</p>';
                return;
            }

            const analysisDiv = document.getElementById('overallAnalysis');
            analysisDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨åˆ†ææ•´ä½“æ•°æ®...</p>';

            // å‡†å¤‡æ•´ä½“æ•°æ®
            const totalDays = healthData.length;
            const weightEntries = healthData.filter(entry => entry.weight !== null);
            const dietEntries = healthData.filter(entry => entry.diet && entry.diet.calories > 0);
            const exerciseEntries = healthData.filter(entry => entry.exercise && entry.exercise.calories > 0);
            const measurementEntries = measurements.filter(entry => entry.chest || entry.waist || entry.arm || entry.leg);

            let weightSummary = 'æ— è®°å½•';
            if (weightEntries.length > 0) {
                const weights = weightEntries.map(e => e.weight);
                weightSummary = `${weights[0]}kg â†’ ${weights[weights.length - 1]}kg (${weights[weights.length - 1] - weights[0] > 0 ? '+' : ''}${(weights[weights.length - 1] - weights[0]).toFixed(1)}kg)`;
            }

            let dietSummary = 'æ— è®°å½•';
            if (dietEntries.length > 0) {
                const totalCalories = dietEntries.reduce((sum, e) => sum + e.diet.calories, 0);
                const avgCalories = Math.round(totalCalories / dietEntries.length);
                const totalProtein = dietEntries.reduce((sum, e) => sum + (e.diet.protein || 0), 0);
                const totalFat = dietEntries.reduce((sum, e) => sum + (e.diet.fat || 0), 0);
                const totalCarbs = dietEntries.reduce((sum, e) => sum + (e.diet.carbs || 0), 0);
                dietSummary = `${dietEntries.length}å¤©ï¼Œå¹³å‡${avgCalories}kcal/å¤©ï¼ˆè›‹ç™½è´¨${totalProtein}gï¼Œè„‚è‚ª${totalFat}gï¼Œç¢³æ°´${totalCarbs}gï¼‰`;
            }

            let exerciseSummary = 'æ— è®°å½•';
            if (exerciseEntries.length > 0) {
                const totalBurned = exerciseEntries.reduce((sum, e) => sum + e.exercise.calories, 0);
                const avgBurned = Math.round(totalBurned / exerciseEntries.length);
                exerciseSummary = `${exerciseEntries.length}å¤©ï¼Œå¹³å‡${avgBurned}kcal/å¤©`;
            }

            // å›´åº¦æ•°æ®æ±‡æ€»
            let measurementSummary = 'æ— è®°å½•';
            if (measurementEntries.length > 0) {
                const chestEntries = measurementEntries.filter(e => e.chest);
                const waistEntries = measurementEntries.filter(e => e.waist);
                const armEntries = measurementEntries.filter(e => e.arm);
                const legEntries = measurementEntries.filter(e => e.leg);

                let measurementDetails = [];
                if (chestEntries.length > 0) {
                    const chests = chestEntries.map(e => e.chest);
                    measurementDetails.push(`èƒ¸å›´ï¼š${chests[0]}cm â†’ ${chests[chests.length - 1]}cm (${chests[chests.length - 1] - chests[0] > 0 ? '+' : ''}${(chests[chests.length - 1] - chests[0]).toFixed(1)}cm)`);
                }
                if (waistEntries.length > 0) {
                    const waists = waistEntries.map(e => e.waist);
                    measurementDetails.push(`è…°å›´ï¼š${waists[0]}cm â†’ ${waists[waists.length - 1]}cm (${waists[waists.length - 1] - waists[0] > 0 ? '+' : ''}${(waists[waists.length - 1] - waists[0]).toFixed(1)}cm)`);
                }
                if (armEntries.length > 0) {
                    const arms = armEntries.map(e => e.arm);
                    measurementDetails.push(`è‡‚å›´ï¼š${arms[0]}cm â†’ ${arms[arms.length - 1]}cm (${arms[arms.length - 1] - arms[0] > 0 ? '+' : ''}${(arms[arms.length - 1] - arms[0]).toFixed(1)}cm)`);
                }
                if (legEntries.length > 0) {
                    const legs = legEntries.map(e => e.leg);
                    measurementDetails.push(`è…¿å›´ï¼š${legs[0]}cm â†’ ${legs[legs.length - 1]}cm (${legs[legs.length - 1] - legs[0] > 0 ? '+' : ''}${(legs[legs.length - 1] - legs[0]).toFixed(1)}cm)`);
                }
                measurementSummary = `${measurementEntries.length}æ¬¡è®°å½•ï¼Œå˜åŒ–ï¼š${measurementDetails.join('ï¼›')}`;
            }

            try {
                // è·å–è‡ªå®šä¹‰æç¤ºè¯
                const customPrompt = localStorage.getItem('customAnalysisPrompt');
                
                // æ„å»ºåŸºç¡€æ•°æ®å­—ç¬¦ä¸²
                const baseData = `è®°å½•æ€»å¤©æ•°ï¼š${totalDays}å¤©\n\nä½“é‡æƒ…å†µï¼š${weightSummary}\n\né¥®é£Ÿæƒ…å†µï¼š${dietSummary}\n\nè¿åŠ¨æƒ…å†µï¼š${exerciseSummary}\n\nå›´åº¦å˜åŒ–ï¼š${measurementSummary}`;

                // æ„å»ºå®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯
                let userMessage;
                if (customPrompt && customPrompt.trim()) {
                    // ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯
                    userMessage = `æ•°æ®ï¼š\n${baseData}\n\n${customPrompt}`;
                } else {
                    // ä½¿ç”¨é»˜è®¤æç¤ºè¯
                    userMessage = `è¯·ç»¼åˆåˆ†æä»¥ä¸‹æ•´ä½“å¥åº·æ•°æ®ï¼š\n\n${baseData}\n\nè¯·é‡ç‚¹åˆ†æä»¥ä¸‹å†…å®¹ï¼š\n\n1. é¥®é£Ÿç»“æ„åˆ†æ\n   - è›‹ç™½è´¨ã€è„‚è‚ªã€ç¢³æ°´åŒ–åˆç‰©çš„æ¯”ä¾‹æ˜¯å¦åˆç†\n   - æ¯æ—¥å¡è·¯é‡Œæ‘„å…¥æ˜¯å¦åˆé€‚\n   - é¥®é£Ÿæ˜¯å¦å‡è¡¡å¥åº·\n\n2. è¿åŠ¨é‡åˆ†æ\n   - æ¯æ—¥è¿åŠ¨æ¶ˆè€—æ˜¯å¦è¶³å¤Ÿ\n   - è¿åŠ¨é¢‘ç‡å’Œå¼ºåº¦å¦‚ä½•\n   - è¿åŠ¨ç±»å‹æ˜¯å¦å¤šæ ·åŒ–\n\n3. å›´åº¦å˜åŒ–åˆ†æ\n   - èƒ¸å›´ã€è…°å›´ã€è‡‚å›´ã€è…¿å›´çš„å˜åŒ–è¶‹åŠ¿\n   - å“ªäº›éƒ¨ä½åœ¨ç¼©å°ï¼Œå“ªäº›åœ¨å¢å¤§\n   - ç»“åˆè¿åŠ¨å’Œé¥®é£Ÿåˆ†æå›´åº¦å˜åŒ–çš„åŸå› \n   - æ˜¯å¦éœ€è¦è°ƒæ•´è¿åŠ¨é‡ç‚¹\n\n4. ä½“é‡é¢„æµ‹\n   - æ ¹æ®å½“å‰çš„é¥®é£Ÿæ‘„å…¥å’Œè¿åŠ¨æ¶ˆè€—å¼ºåº¦\n   - ç»“åˆå†å²ä½“é‡å˜åŒ–è¶‹åŠ¿\n   - é¢„æµ‹å¦‚æœä¿æŒè¿™ä¸ªå¼ºåº¦ï¼Œæ˜å¤©çš„ä½“é‡å¯èƒ½æ˜¯å¤šå°‘\n   - ç»™å‡ºé¢„æµ‹çš„ä¾æ®å’ŒèŒƒå›´\n\nè¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€ï¼Œåˆ†ç‚¹åˆ—å‡ºï¼Œç»™å‡ºä¸“ä¸šè€Œå®ç”¨çš„å»ºè®®ã€‚`;
                }

                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·ç®¡ç†å’Œè¥å…»å­¦ä¸“å®¶ã€‚è¯·ç»¼åˆåˆ†æç”¨æˆ·çš„é¥®é£Ÿã€è¿åŠ¨ã€ä½“é‡å’Œå›´åº¦æ•°æ®ï¼Œç»™å‡ºå…¨é¢ã€ä¸“ä¸šçš„æ•´ä½“è¯„ä¼°å’Œå»ºè®®ã€‚ç”¨å‹å¥½ã€é¼“åŠ±çš„è¯­æ°”ã€‚'
                            },
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const analysis = data.choices[0].message.content;

                // æ ¼å¼åŒ–æ˜¾ç¤ºåˆ†æç»“æœ
                const formattedAnalysis = analysis
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢/g, 'ğŸ“Œ')
                    .replace(/1\./g, 'âœ…')
                    .replace(/2\./g, 'âœ…')
                    .replace(/3\./g, 'âœ…')
                    .replace(/4\./g, 'âœ…')
                    .replace(/5\./g, 'âœ…')
                    .replace(/6\./g, 'âœ…')
                    .replace(/7\./g, 'âœ…');

                analysisDiv.innerHTML = `
                    <div style="font-size: 0.95em; line-height: 1.6;">
                        ${formattedAnalysis}
                    </div>
                `;

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                analysisDiv.innerHTML = `<p style="color: #e74c3c;">âŒ åˆ†æå¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // AI æ™ºèƒ½é—®ç­”
        async function askAIQuestion() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://vg.v1api.cc/v1';
            const modelName = localStorage.getItem('modelName') || 'gpt-4o-mini';
            const question = document.getElementById('aiQuestion').value.trim();

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            if (!question) {
                alert('è¯·è¾“å…¥é—®é¢˜');
                return;
            }

            if (healthData.length === 0) {
                document.getElementById('aiAnswer').innerHTML = '<p style="color: #999; font-style: italic;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ å¥åº·è®°å½•ã€‚</p>';
                return;
            }

            const answerDiv = document.getElementById('aiAnswer');
            answerDiv.innerHTML = '<p style="color: #667eea;">ğŸ”„ æ­£åœ¨æ€è€ƒ...</p>';

            try {
                // å‡†å¤‡è¯¦ç»†çš„å¥åº·æ•°æ®
                const detailedData = healthData.map(entry => {
                    let entryText = `æ—¥æœŸï¼š${entry.date}\n`;
                    if (entry.weight) entryText += `ä½“é‡ï¼š${entry.weight}kg\n`;
                    if (entry.diet && entry.diet.foodItems) {
                        entryText += `é£Ÿç‰©ï¼š${entry.diet.foodItems.map(item => item.description).join('ï¼Œ')}\n`;
                        entryText += `æ€»æ‘„å…¥ï¼š${entry.diet.calories}kcalï¼ˆè›‹ç™½è´¨${entry.diet.protein}gï¼Œè„‚è‚ª${entry.diet.fat}gï¼Œç¢³æ°´${entry.diet.carbs}gï¼‰\n`;
                    }
                    if (entry.exercise && entry.exercise.exerciseItems) {
                        entryText += `è¿åŠ¨ï¼š${entry.exercise.exerciseItems.map(item => item.description).join('ï¼Œ')}\n`;
                        entryText += `æ€»æ¶ˆè€—ï¼š${entry.exercise.calories}kcal\n`;
                    }
                    if (entry.diet && entry.exercise) {
                        const balance = entry.diet.calories - entry.exercise.calories;
                        entryText += `å¡è·¯é‡Œå¹³è¡¡ï¼š${balance > 0 ? '+' : ''}${balance}kcal\n`;
                    }
                    return entryText;
                }).join('\n------------------\n');

                // å‡†å¤‡å›´åº¦æ•°æ®
                const measurementsData = measurements.map(entry => {
                    let entryText = `æ—¥æœŸï¼š${entry.date}\n`;
                    if (entry.chest) entryText += `èƒ¸å›´ï¼š${entry.chest}cm\n`;
                    if (entry.waist) entryText += `è…°å›´ï¼š${entry.waist}cm\n`;
                    if (entry.arm) entryText += `è‡‚å›´ï¼š${entry.arm}cm\n`;
                    if (entry.leg) entryText += `è…¿å›´ï¼š${entry.leg}cm\n`;
                    return entryText;
                }).join('\n------------------\n');

                const response = await fetch(`${apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·ç®¡ç†å’Œè¥å…»å­¦ä¸“å®¶ã€‚è¯·åŸºäºç”¨æˆ·æä¾›çš„è¯¦ç»†å¥åº·æ•°æ®ï¼ˆåŒ…æ‹¬ä½“é‡ã€é¥®é£Ÿã€è¿åŠ¨å’Œå›´åº¦æ•°æ®ï¼‰å›ç­”é—®é¢˜ã€‚ä½ çš„å›ç­”åº”è¯¥ï¼š\n1. åŸºäºæ•°æ®ç»™å‡ºå‡†ç¡®çš„åˆ†æ\n2. æä¾›å®ç”¨ã€å¯æ“ä½œçš„å»ºè®®\n3. ç”¨å‹å¥½ã€é¼“åŠ±çš„è¯­æ°”\n4. å¦‚æœæ•°æ®ä¸è¶³ä»¥å›ç­”ï¼Œè¯·å¦‚å®è¯´æ˜\n5. ç‰¹åˆ«å…³æ³¨å›´åº¦å˜åŒ–ä¸é¥®é£Ÿã€è¿åŠ¨ä¹‹é—´çš„å…³ç³»'
                            },
                            {
                                role: 'user',
                                content: `é—®é¢˜ï¼š${question}\n\nä»¥ä¸‹æ˜¯æˆ‘çš„è¯¦ç»†å¥åº·æ•°æ®ï¼ˆä½“é‡ã€é¥®é£Ÿã€è¿åŠ¨ï¼‰ï¼š\n${detailedData}\n\nä»¥ä¸‹æ˜¯æˆ‘çš„å›´åº¦æ•°æ®ï¼ˆèƒ¸å›´ã€è…°å›´ã€è‡‚å›´ã€è…¿å›´ï¼‰ï¼š\n${measurementsData || 'æš‚æ— å›´åº¦è®°å½•'}\n\nè¯·åŸºäºä»¥ä¸Šæ‰€æœ‰æ•°æ®å›ç­”æˆ‘çš„é—®é¢˜ã€‚`
                            }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const answer = data.choices[0].message.content;

                // æ ¼å¼åŒ–æ˜¾ç¤ºå›ç­”
                const formattedAnswer = answer
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢/g, 'ğŸ“Œ')
                    .replace(/1\./g, 'âœ…')
                    .replace(/2\./g, 'âœ…')
                    .replace(/3\./g, 'âœ…')
                    .replace(/4\./g, 'âœ…')
                    .replace(/5\./g, 'âœ…');

                answerDiv.innerHTML = `
                    <div style="font-size: 0.95em; line-height: 1.6;">
                        ${formattedAnswer}
                    </div>
                `;

            } catch (error) {
                console.error('å›ç­”å¤±è´¥:', error);
                answerDiv.innerHTML = `<p style="color: #e74c3c;">âŒ å›ç­”å¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        // æ¸…ç©ºæ•°æ®
        function clearData() {
            if (healthData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯æ¸…ç©ºï¼');
                return;
            }

            const confirmMessage = `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¥åº·æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ ${healthData.length} æ¡è®°å½•ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
            
            if (confirm(confirmMessage)) {
                try {
                    healthData = [];
                    saveData();
                    updateUI();
                    
                    alert('âœ… æ•°æ®å·²æ¸…ç©ºï¼');
                } catch (error) {
                    console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                    alert('âŒ æ¸…ç©ºæ•°æ®å¤±è´¥ï¼š' + error.message);
                }
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (healthData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            try {
                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    data: healthData
                };

                // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const today = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `å¥åº·è¿½è¸ªæ•°æ®_${today}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶åï¼šå¥åº·è¿½è¸ªæ•°æ®_' + today + '.json\n\nè¯·å¦¥å–„ä¿å­˜æ­¤æ–‡ä»¶ï¼Œç”¨äºå°†æ¥æ¢å¤æ•°æ®ã€‚');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // å¯¼å…¥æ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importedData.version || !importedData.data || !Array.isArray(importedData.data)) {
                        throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼');
                    }

                    // ç¡®è®¤å¯¼å…¥
                    const recordCount = importedData.data.length;
                    const confirmMessage = `å³å°†å¯¼å…¥ ${recordCount} æ¡è®°å½•ã€‚\n\nå¯¼å…¥åä¼šè¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`;
                    
                    if (confirm(confirmMessage)) {
                        // ä¿å­˜å¯¼å…¥çš„æ•°æ®
                        healthData = importedData.data;
                        saveData();
                        updateUI();
                        
                        alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå·²å¯¼å…¥ ' + recordCount + ' æ¡è®°å½•ã€‚');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼š\n' + error.message + '\n\nè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æ­£ç¡®çš„å¥åº·è¿½è¸ªå™¨å¯¼å‡ºçš„JSONæ–‡ä»¶ã€‚');
                }
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼è¯·é‡è¯•ã€‚');
            };
            
            reader.readAsText(file);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initDates();
            updateUI();
            updateCurrentBMI();

            // åˆå§‹åŒ–ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºä»Šå¤©çš„æ•°æ®
            const today = new Date().toISOString().split('T')[0];
            updateStatsForDate(today);

            // è®¾ç½®æ™ºèƒ½è®°å½•æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤ä¸ºä»Šå¤©
            document.getElementById('nlDateInput').value = today;

            // è®¾ç½®å®æ—¶æ›´æ–°ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ•°æ®å˜åŒ–ï¼‰
            setInterval(updateUI, 30000);
        });
    </script>
</body>
</html>
